import asyncio
import json
import random
from dataclasses import dataclass, field
from typing import Dict, List, Any

from aiogram import Bot, Dispatcher, F
from aiogram.filters import CommandStart, Command
from aiogram.types import (
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)

TOKEN = "8583421204:AAHB_2Y8RjDQHDQLcqDLJkYfiP6oBqq3SyE"

bot = Bot(token=TOKEN)
dp = Dispatcher()

# ---------- –ó–ê–ì–†–£–ó–ö–ê –°–õ–û–í ----------

def load_words(path: str = "words.json") -> List[Dict[str, str]]:
    with open(path, "r", encoding="utf-8") as f:
        data = json.load(f)
    # –Ω–µ–º–Ω–æ–≥–æ —á–∏—Å—Ç–∏–º –ø—Ä–æ–±–µ–ª—ã
    for w in data:
        w["de"] = w["de"].strip()
        w["ru"] = w["ru"].strip()
        w["tr"] = w["tr"].strip()
    return data


ALL_WORDS: List[Dict[str, str]] = load_words()

# ---------- –¢–ï–ú–´ –ò –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï ----------

# id —Ç–µ–º—ã -> –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (–±–µ–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–∏–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
TOPIC_TITLES: Dict[str, str] = {
    "all": "üé≤ –í—Å–µ —Ç–µ–º—ã (–ø–µ—Ä–µ–º–µ—à–∫—É)",
    "abstract": "–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è",
    "verbs": "–ë–∞–∑–æ–≤—ã–µ –≥–ª–∞–≥–æ–ª—ã",
    "time_calendar": "–í—Ä–µ–º—è –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å",
    "city_transport": "–ì–æ—Ä–æ–¥ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
    "home": "–î–æ–º –∏ –∂–∏–ª—å–µ",
    "food_shop": "–ï–¥–∞ –∏ –º–∞–≥–∞–∑–∏–Ω",
    "animals": "–ñ–∏–≤–æ—Ç–Ω—ã–µ",
    "tools_house": "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –±—ã—Ç",
    "computer_internet": "–ö–æ–º–ø—å—é—Ç–µ—Ä –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
    "personal_data": "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
    "clothes": "–û–¥–µ–∂–¥–∞",
    "weather_nature": "–ü–æ–≥–æ–¥–∞ –∏ –ø—Ä–∏—Ä–æ–¥–∞",
    "objects": "–ü—Ä–µ–¥–º–µ—Ç—ã –∏ –≤–µ—â–∏",
    "greetings": "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã",
    "jobs_work": "–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞",
    "family": "–°–µ–º—å—è",
    "body_health": "–¢–µ–ª–æ –∏ –∑–¥–æ—Ä–æ–≤—å–µ",
    "hobby_sport": "–•–æ–±–±–∏ –∏ —Å–ø–æ—Ä—Ç",
    "colors_numbers": "–¶–≤–µ—Ç–∞ –∏ —á–∏—Å–ª–∞",
    "school_study": "–®–∫–æ–ª–∞ –∏ —É—á–µ–±–∞",
    "emotions_character": "–≠–º–æ—Ü–∏–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä",
    "dictionary": "–°–ª–æ–≤–∞—Ä—å A1-B1",
}

# –ù–∞–±–æ—Ä—ã –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ —Ä—É—Å—Å–∫–æ–º –ø–µ—Ä–µ–≤–æ–¥–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
TOPIC_KEYWORDS_RU: Dict[str, List[str]] = {
    "greetings": [
        "–ø—Ä–∏–≤–µ—Ç",
        "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å",
        "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä",
        "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
        "–¥–æ–±—Ä–æ–π –Ω–æ—á–∏",
        "–∫–∞–∫ –¥–µ–ª–∞",
        "—Å–ø–∞—Å–∏–±–æ",
        "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞",
        "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è",
        "–ø–æ–∫–∞",
        "–≤–µ—Ä–Ω–æ",
        "–ø—Ä–∞–≤–∏–ª—å–Ω–æ",
        "–æ–∫–µ–π",
        "–º–Ω–µ –∂–∞–ª—å",
        "–¥–∞",
        "–Ω–µ—Ç",
    ],
    "personal_data": [
        "–∏–º—è",
        "—Ñ–∞–º–∏–ª–∏—è",
        "—É–ª–∏—Ü–∞",
        "–Ω–æ–º–µ—Ä –¥–æ–º–∞",
        "–∞–¥—Ä–µ—Å",
        "–ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å",
        "–º–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è",
        "–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
        "–ø–æ—á—Ç–∞",
        "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å",
        "–ø–æ–¥–ø–∏—Å—å",
        "–≤–æ–∑—Ä–∞—Å—Ç",
        "–≥–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è",
    ],
    "family": [
        "—Å–µ–º—å—è",
        "–º–∞—Ç—å",
        "–æ—Ç–µ—Ü",
        "—Å—ã–Ω",
        "–¥–æ—á—å",
        "–±–∞–±—É—à–∫–∞",
        "–¥–µ–¥",
        "–≤–Ω—É–∫",
        "–≤–Ω—É—á–∫–∞",
        "–±—Ä–∞—Ç",
        "—Å–µ—Å—Ç—Ä–∞",
        "—Ç–µ—Ç—è",
        "–¥—è–¥—è",
        "–¥–≤–æ—é—Ä–æ–¥–Ω—ã–π",
        "–¥–≤–æ—é—Ä–æ–¥–Ω–∞—è",
        "–∂–µ–Ω–∞—Ç",
        "–∑–∞–º—É–∂–µ–º",
        "—Ä–∞–∑–≤–µ–¥–µ–Ω",
        "–≤–¥–æ–≤–µ—Ü",
        "–æ–¥–∏–Ω–æ–∫–∏–π —Ä–æ–¥–∏—Ç–µ–ª—å",
    ],
    "verbs": [
        "—è –µ—Å—Ç—å",
        "—Ç—ã –µ—Å—Ç—å",
        "–æ–Ω –µ—Å—Ç—å",
        "–∏–º–µ—Ç—å",
        "—è –∏–º–µ—é",
        "—Ç—ã –∏–º–µ–µ—à—å",
        "–æ–Ω –∏–º–µ–µ—Ç",
        "–∂–∏—Ç—å",
        "—è –∂–∏–≤—É",
        "—Ç—ã –∂–∏–≤–µ—à—å",
        "–æ–Ω –∂–∏–≤–µ—Ç",
        "–≥–æ–≤–æ—Ä–∏—Ç—å",
        "—è –≥–æ–≤–æ—Ä—é",
        "—Ç—ã –≥–æ–≤–æ—Ä–∏—à—å",
        "–æ–Ω –≥–æ–≤–æ—Ä–∏—Ç",
        "—Ä–∞–±–æ—Ç–∞—Ç—å",
        "—É—á–∏—Ç—å—Å—è",
        "—É—á–∏—Ç—å—Å—è –≤ –≤—É–∑–µ",
        "–µ—Å—Ç—å",
        "–≥–æ—Ç–æ–≤–∏—Ç—å",
        "–∏—Å–∫–∞—Ç—å",
        "–∏–¥—Ç–∏",
        "–∑–≤–æ–Ω–∏—Ç—å",
        "–¥—É–º–∞—Ç—å",
        "–¥–µ–ª–∞—Ç—å",
        "–ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å –ø–æ –±—É–∫–≤–∞–º",
        "–ª—é–±–∏—Ç—å (–µ–¥—É)",
        "—Ö–æ—Ç–µ–ª –±—ã",
        "–Ω—É–∂–¥–∞—Ç—å—Å—è",
        "–∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å",
        "—Å—á–∏—Ç–∞—Ç—å",
        "–ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å",
        "–∂–µ–Ω–∏—Ç—å—Å—è",
        "–≤—ã–π—Ç–∏ –∑–∞–º—É–∂",
        "–ø–æ–∫—É–ø–∞—Ç—å",
        "–∑–∞–∫—É–ø–∞—Ç—å—Å—è",
        "–º–æ—á—å",
        "—Ö–æ—Ç–µ—Ç—å",
        "—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è",
        "–¥–∞–≤–∞—Ç—å",
        "–∂–¥–∞—Ç—å",
        "–ø–æ–º–æ–≥–∞—Ç—å",
        "–æ–ø–∏—Å—ã–≤–∞—Ç—å",
        "—Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å",
        "—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å",
        "—É–¥–∏–≤–ª—è—Ç—å",
        "—Ä–∞–∑—Ä–µ—à–∞—Ç—å",
        "–∑–∞–ø—Ä–µ—â–∞—Ç—å",
        "–∏–∑–≤–∏–Ω—è—Ç—å—Å—è",
        "–æ–±–æ—Å–Ω–æ–≤—ã–≤–∞—Ç—å",
        "–¥–æ—Å—Ç–∏–≥–∞—Ç—å",
        "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å",
    ],
    "time_calendar": [
        "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
        "–≤—Ç–æ—Ä–Ω–∏–∫",
        "—Å—Ä–µ–¥–∞",
        "—á–µ—Ç–≤–µ—Ä–≥",
        "–ø—è—Ç–Ω–∏—Ü–∞",
        "—Å—É–±–±–æ—Ç–∞",
        "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
        "—É—Ç—Ä–æ",
        "–≤–µ—á–µ—Ä",
        "–Ω–æ—á—å",
        "–ø–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è",
        "–≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è",
        "–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å",
        "–º–µ—Å—è—Ü",
        "–º–∞—Ä—Ç",
        "–∞–ø—Ä–µ–ª—å",
        "–º–∞–π",
        "–∏—é–Ω—å",
        "–∏—é–ª—å",
        "–∞–≤–≥—É—Å—Ç",
        "—Å–µ–Ω—Ç—è–±—Ä—å",
        "–æ–∫—Ç—è–±—Ä—å",
        "–Ω–æ—è–±—Ä—å",
        "–¥–µ–∫–∞–±—Ä—å",
        "–≤—Ä–µ–º—è",
        "–Ω–µ–¥–µ–ª—è",
        "—Å–µ–≥–æ–¥–Ω—è",
        "–∑–∞–≤—Ç—Ä–∞",
    ],
    "city_transport": [
        "–≥–æ—Ä–æ–¥",
        "–¥–µ—Ä–µ–≤–Ω—è",
        "—É–ª–∏—Ü–∞",
        "–ø–ª–æ—â–∞–¥—å",
        "–ø–∞—Ä–∫",
        "–º–æ—Å—Ç",
        "–≤–æ–∫–∑–∞–ª",
        "–∞—ç—Ä–æ–ø–æ—Ä—Ç",
        "–æ—Å—Ç–∞–Ω–æ–≤–∫–∞",
        "–º–µ—Ç—Ä–æ",
        "—ç–ª–µ–∫—Ç—Ä–∏—á–∫–∞",
        "–ø–æ–µ–∑–¥",
        "–∞–≤—Ç–æ–±—É—Å",
        "—Ç–∞–∫—Å–∏",
        "–ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫",
        "—Å–≤–µ—Ç–æ—Ñ–æ—Ä",
        "–∞–ø—Ç–µ–∫–∞",
        "–ø–µ–∫–∞—Ä–Ω—è",
        "–±–∞–Ω–∫",
        "–ø–æ—á—Ç–∞",
        "–ø–æ–ª–∏—Ü–∏—è",
        "—à–∫–æ–ª–∞",
        "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
        "–¥–µ—Ç—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞",
        "–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä",
        "—Ç–µ–∞—Ç—Ä",
        "–º—É–∑–µ–π",
        "–ø–æ—Ä—Ç",
        "–ø–∞—Ä–∫–æ–≤–∫–∞",
        "—Ä—ã–Ω–æ–∫",
    ],
    "home": [
        "–¥–æ–º",
        "–∫–≤–∞—Ä—Ç–∏—Ä–∞",
        "–∫–æ–º–Ω–∞—Ç–∞",
        "–≥–æ—Å—Ç–∏–Ω–∞—è",
        "—Å–ø–∞–ª—å–Ω—è",
        "–∫—É—Ö–Ω—è",
        "–≤–∞–Ω–Ω–∞—è",
        "—Ç—É–∞–ª–µ—Ç",
        "–∫–æ—Ä–∏–¥–æ—Ä",
        "–±–∞–ª–∫–æ–Ω",
        "—Å–∞–¥",
        "–æ–∫–Ω–æ",
        "–¥–≤–µ—Ä—å",
        "–∫—Ä–æ–≤–∞—Ç—å",
        "—à–∫–∞—Ñ",
        "–¥–∏–≤–∞–Ω",
        "–ª–∞–º–ø–∞",
        "–∫–æ–≤–µ—Ä",
        "—Å—Ç–µ–Ω–∞",
        "–ø–æ–ª",
        "–ø–æ—Ç–æ–ª–æ–∫",
        "—Å—Ç–æ–ª",
        "—Å—Ç—É–ª",
        "–∑–µ—Ä–∫–∞–ª–æ",
        "—à—Ç–æ—Ä–∞",
        "—Å—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞",
        "—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫",
        "–ø–ª–∏—Ç–∞",
        "–¥—É—Ö–æ–≤–∫–∞",
        "–≤–∞–Ω–Ω–∞ (–∫–∞–∫ –ø—Ä–µ–¥–º–µ—Ç)",
        "–≤—Ö–æ–¥",
    ],
    "food_shop": [
        "–∫–æ—Ñ–µ",
        "—á–∞–π",
        "–º–æ–ª–æ–∫–æ",
        "–≤–æ–¥–∞",
        "—Å–æ–∫",
        "–ø–∏–≤–æ",
        "—Ö–ª–µ–±",
        "–±—É–ª–æ—á–∫–∞",
        "–∫—Ä—É–∞—Å—Å–∞–Ω",
        "—è–π—Ü–æ",
        "—è–±–ª–æ–∫–æ",
        "–≥—Ä—É—à–∞",
        "—Ñ—Ä—É–∫—Ç—ã",
        "–º—é—Å–ª–∏",
        "–π–æ–≥—É—Ä—Ç",
        "—Ç–æ—Ä—Ç",
        "–∫–æ–ª–±–∞—Å–∞",
        "—Å—ã—Ä",
        "–ø–æ–∫—É–ø–∫–∞",
        "–µ–≤—Ä–æ",
        "—Ü–µ–Ω—Ç",
        "—Å—Ç–æ–∏—Ç",
        "–∫–ª–∏–µ–Ω—Ç",
        "–∫–ª–∏–µ–Ω—Ç–∫–∞",
        "–ø–∞–∫–µ—Ç",
        "–ø—Ä–æ–¥—É–∫—Ç –ø–∏—Ç–∞–Ω–∏—è",
        "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç",
        "–µ–¥–∞",
        "–ª—é–±–∏–º–∞—è –µ–¥–∞",
        "—Ä–∏—Å",
        "—à–æ–∫–æ–ª–∞–¥",
        "–º–æ—Ä–æ–∂–µ–Ω–æ–µ",
        "—Å—É–ø",
        "—É–∂–∏–Ω",
        "–æ–±–µ–¥",
        "–º–∞—Å–ª–æ",
        "—Ä—ã–±–∞",
        "—Å—á–µ—Ç",
        "–¥–µ—Å–µ—Ä—Ç",
        "–Ω–∞–ø–∏—Ç–æ–∫",
        "–±–∞–Ω–∫–∞",
        "–±—É—Ç—ã–ª–∫–∞",
        "–≥—Ä–∞–º–º",
        "–∫–∏–ª–æ–≥—Ä–∞–º–º",
        "–ª–∏—Ç—Ä",
        "–∫–∞—Ä—Ç–æ—à–∫–∞",
        "–≤–µ—Ç—á–∏–Ω–∞",
        "–ø–æ–º–∏–¥–æ—Ä",
        "—Å–ª–∏–≤–∫–∏",
        "–±–∞–Ω–∞–Ω",
        "–æ–≤–æ—â–∏",
        "–º—è—Å–æ",
        "–≤–µ–≥–∞–Ω—Å–∫–∏–π",
        "–≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–∏–π",
    ],
    "animals": [
        "—Å–æ–±–∞–∫–∞",
        "–∫–æ—à–∫–∞",
        "–ø—Ç–∏—Ü–∞",
        "–ª–æ—à–∞–¥—å",
        "–∫–æ—Ä–æ–≤–∞",
        "—Å–≤–∏–Ω—å—è",
        "–æ–≤—Ü–∞",
        "–º—ã—à—å",
        "–º–µ–¥–≤–µ–¥—å",
        "–ª–µ–≤",
        "–∑–º–µ—è",
        "—Ç–∏–≥—Ä",
        "–∑–∞—è—Ü",
        "–æ–±–µ–∑—å—è–Ω–∞",
        "–≤–µ—Ä–±–ª—é–¥",
        "–≤–æ–ª–∫",
        "–ª–∏—Å–∞",
        "–ø–µ—Ç—É—Ö",
        "—É—Ç–∫–∞",
        "—Ä—ã–±–∞",
    ],
    "tools_house": [
        "–º–æ–ª–æ—Ç–æ–∫",
        "–≥–≤–æ–∑–¥—å",
        "–≤–∏–Ω—Ç",
        "–æ—Ç–≤–µ—Ä—Ç–∫–∞",
        "–¥—Ä–µ–ª—å",
        "–ø–∏–ª–∞",
        "–ø–ª–æ—Å–∫–æ–≥—É–±—Ü—ã",
        "—à–ª–∞–Ω–≥",
        "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
        "–ø—ã–ª–µ—Å–æ—Å",
        "–º–µ—Ç–ª–∞",
        "–≤–µ–¥—Ä–æ",
        "–≥—É–±–∫–∞",
        "—Ç—Ä—è–ø–∫–∞",
        "—Ä–æ–∑–µ—Ç–∫–∞",
        "–≤–∏–ª–∫–∞ (—ç–ª–µ–∫—Ç—Ä–∏—á.)",
        "–ª–∞–º–ø–æ—á–∫–∞",
        "–º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞",
        "—á–∞–π–Ω–∏–∫ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π",
        "–º—É—Å–æ—Ä",
        "–º—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç",
        "–º—É—Å–æ—Ä–Ω—ã–π –±–∞–∫",
    ],
    "computer_internet": [
        "–∫–æ–º–ø—å—é—Ç–µ—Ä",
        "–Ω–æ—É—Ç–±—É–∫",
        "–º—ã—à—å",
        "–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞",
        "—ç–∫—Ä–∞–Ω",
        "–º–æ–Ω–∏—Ç–æ—Ä",
        "—Ñ–∞–π–ª",
        "–ø–∞–ø–∫–∞",
        "—Å–æ—Ö—Ä–∞–Ω—è—Ç—å",
        "—É–¥–∞–ª—è—Ç—å",
        "–ø–∞—Ä–æ–ª—å",
        "–≤—Ö–æ–¥–∏—Ç—å (–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è)",
        "–≤—ã—Ö–æ–¥–∏—Ç—å (–∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞)",
        "–ø—Ä–æ–≥—Ä–∞–º–º–∞",
        "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        "—Å–∫–∞—á–∏–≤–∞—Ç—å",
        "–∑–∞–≥—Ä—É–∂–∞—Ç—å (–≤ —Å–µ—Ç—å)",
        "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
        "–≤–∞–π-—Ñ–∞–π",
        "—Å–∏–¥–µ—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ",
    ],
    "clothes": [
        "—Ä—É–±–∞—à–∫–∞",
        "—à—Ç–∞–Ω—ã",
        "–¥–∂–∏–Ω—Å—ã",
        "—Ñ—É—Ç–±–æ–ª–∫–∞",
        "—Å–≤–∏—Ç–µ—Ä",
        "–∫—É—Ä—Ç–∫–∞",
        "–ø–∞–ª—å—Ç–æ",
        "–±–ª—É–∑–∫–∞",
        "—é–±–∫–∞",
        "–ø–ª–∞—Ç—å–µ",
        "–æ–±—É–≤—å",
        "–±–æ—Ç–∏–Ω–æ–∫",
        "–Ω–æ—Å–∫–∏",
        "—Å–∞–ø–æ–≥–∏",
        "—Ä–µ–º–µ–Ω—å",
        "—à–ª—è–ø–∞",
        "—à–∞–ø–∫–∞",
        "—à–∞—Ä—Ñ",
        "–ø–µ—Ä—á–∞—Ç–∫–∏",
        "—Ç—Ä—É—Å—ã",
        "–ª–∏—Ñ—á–∏–∫",
        "–∫–æ—Å—Ç—é–º",
        "–æ–¥–µ–∂–¥–∞",
        "–º–æ–¥–∞",
        "—Ç–∫–∞–Ω—å",
        "–ø—É–≥–æ–≤–∏—Ü–∞",
        "–º–æ–ª–Ω–∏—è",
        "—Ä–∞–∑–º–µ—Ä",
    ],
    "weather_nature": [
        "–ø–æ–≥–æ–¥–∞",
        "–ø–∞—Å–º—É—Ä–Ω–æ",
        "–∏–¥–µ—Ç –¥–æ–∂–¥—å",
        "–∏–¥–µ—Ç —Å–Ω–µ–≥",
        "—Å–≤–µ—Ç–∏—Ç —Å–æ–ª–Ω—Ü–µ",
        "—Ç–µ–ø–ª–æ",
        "—Ö–æ–ª–æ–¥–Ω–æ",
        "–≤–µ—Å–Ω–∞",
        "–ª–µ—Ç–æ",
        "–æ—Å–µ–Ω—å",
        "–∑–∏–º–∞",
        "–≥—Ä–∞–¥—É—Å",
        "–¥–æ–∂–¥—å",
        "—Å–Ω–µ–≥",
        "—Å–æ–ª–Ω—Ü–µ",
        "–≤–µ—Ç–µ—Ä",
        "—Ç—É–º–∞–Ω",
        "—à—Ç–æ—Ä–º",
        "–Ω–µ–±–æ",
        "–æ–±–ª–∞–∫–æ",
        "–ø—Ä–∏—Ä–æ–¥–∞",
        "–∑–µ–º–ª—è",
        "–ø–ª–∞–Ω–µ—Ç–∞",
        "–≤–æ–∑–¥—É—Ö",
        "–∫–ª–∏–º–∞—Ç",
        "—Ä–∞–¥—É–≥–∞",
        "–ª–µ—Å",
        "—Ä–µ–∫–∞",
        "—Ä—É—á–µ–π",
        "—Ö–æ–ª–º",
        "–ª—É–≥",
        "–ø–æ–ª–µ",
        "—Å–∫–∞–ª–∞",
        "–ø–ª—è–∂",
        "–º–æ—Ä–µ",
        "–æ–∑–µ—Ä–æ",
    ],
    "objects": [
        "–∫–Ω–∏–≥–∞",
        "—Ç–µ—Ç—Ä–∞–¥—å",
        "–±—É–º–∞–≥–∞",
        "–∫–∞—Ä–∞–Ω–¥–∞—à",
        "—Ä—É—á–∫–∞",
        "–ª–∏–Ω–µ–π–∫–∞",
        "–∫–∞–º–µ—Ä–∞",
        "–ø—Ä–∏–Ω—Ç–µ—Ä",
        "—Ç–µ–ª–µ—Ñ–æ–Ω",
        "—Å—É–º–∫–∞",
        "—Ä—é–∫–∑–∞–∫",
        "–∫–æ—à–µ–ª–µ–∫",
        "–∫–ª—é—á",
        "–∫–ª–µ–π",
        "–Ω–æ–∂–Ω–∏—Ü—ã",
        "–∑–æ–Ω—Ç",
        "–æ—á–∫–∏",
        "–∑–∞–∂–∏–≥–∞–ª–∫–∞",
        "–≥–∞–∑–µ—Ç–∞",
        "—á–∞—à–∫–∞",
        "—á–µ–º–æ–¥–∞–Ω",
        "–∏–≥—Ä–∞",
        "–∏–≥—Ä—É—à–∫–∞",
    ],
    "jobs_work": [
        "–≤—Ä–∞—á",
        "—É—á–∏—Ç–µ–ª—å",
        "–∏–Ω–∂–µ–Ω–µ—Ä",
        "–ø–æ–≤–∞—Ä",
        "–º–µ–¥–±—Ä–∞—Ç",
        "–º–µ–¥—Å–µ—Å—Ç—Ä–∞",
        "—Ç–∞–∫—Å–∏—Å—Ç",
        "–ø—Ä–æ–¥–∞–≤–µ—Ü",
        "–ø—Ä–æ–¥–∞–≤—â–∏—Ü–∞",
        "–ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä",
        "–ø–µ–≤–µ—Ü",
        "–ø–µ–≤–∏—Ü–∞",
        "–æ—Ñ–∏—Ü–∏–∞–Ω—Ç",
        "–∞–∫—Ç—Ä–∏—Å–∞",
        "—ç–ª–µ–∫—Ç—Ä–æ–Ω—â–∏–∫",
        "–¥–æ–º–æ—Ö–æ–∑—è–∏–Ω",
        "–¥–æ–º–æ—Ö–æ–∑—è–π–∫–∞",
        "–ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π",
        "—Å—Ç—É–¥–µ–Ω—Ç",
        "—Å—Ç—É–¥–µ–Ω—Ç–∫–∞",
        "—Ä–∞–±–æ—Ç–∞",
        "–ø—Ä–æ—Ñ–µ—Å—Å–∏—è",
        "–Ω–∞—á–∞–ª—å–Ω–∏–∫",
        "–Ω–∞—á–∞–ª—å–Ω–∏—Ü–∞",
        "–æ—Ñ–∏—Å",
        "—Ñ–∏—Ä–º–∞",
        "–∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É",
        "—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ",
        "—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è",
        "–ø–µ—Ä–µ—Ä—ã–≤",
        "–∑–∞—Ä–ø–ª–∞—Ç–∞",
        "–æ–∫–ª–∞–¥",
        "–ø–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å",
        "–Ω–µ–ø–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å",
        "–∫–æ–º–∞–Ω–¥–∞",
        "—Å–æ–≤–µ—â–∞–Ω–∏–µ",
        "—à–µ—Ñ-–ø–æ–≤–∞—Ä",
        "–≤–ª–∞–¥–µ–ª–µ—Ü",
        "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫",
        "–¥–æ—Å—Ç–∞–≤–∫–∞",
        "–∑–∞–∫–∞–∑",
        "–∫–æ–Ω—Ç—Ä–∞–∫—Ç",
        "—Å–∫–∏–¥–∫–∞",
        "—Å–µ—Ä–≤–∏—Å",
        "–∫–ª–∏–µ–Ω—Ç",
    ],
    "body_health": [
        "—Ç–µ–ª–æ",
        "–≥–æ–ª–æ–≤–∞",
        "–ª–∏—Ü–æ",
        "–ª–æ–±",
        "—â–µ–∫–∞",
        "–≥—É–±—ã",
        "—è–∑—ã–∫",
        "—à–µ—è",
        "–ø–ª–µ—á–æ",
        "—Ä—É–∫–∞",
        "–∫–∏—Å—Ç—å —Ä—É–∫–∏",
        "–ø–∞–ª–µ—Ü",
        "–≥—Ä—É–¥—å",
        "—Å–ø–∏–Ω–∞",
        "–∂–∏–≤–æ—Ç",
        "–Ω–æ–≥–∞",
        "—Å—Ç–æ–ø–∞",
        "–∫–æ–ª–µ–Ω–æ",
        "–∫–æ—Å—Ç—å",
        "–∫—Ä–æ–≤—å",
        "–ª–µ–≥–∫–æ–µ",
        "–ø–µ—á–µ–Ω—å",
        "–º—ã—à—Ü–∞",
        "–±–æ–ª—å",
        "–≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å",
        "–±–æ–ª—å –≤ –≥–æ—Ä–ª–µ",
        "–ø—Ä–æ—Å—Ç—É–¥–∞",
        "–≥—Ä–∏–ø–ø",
        "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –∂–∞—Ä",
        "—Ç–∞–±–ª–µ—Ç–∫–∞",
        "–ª–µ–∫–∞—Ä—Å—Ç–≤–æ",
        "–º–∞–∑—å",
        "–ø–æ–≤—è–∑–∫–∞",
        "–±–∏–Ω—Ç",
        "–∑–¥–æ—Ä–æ–≤—å–µ",
        "–∑–¥–æ—Ä–æ–≤—ã–π",
        "–±–æ–ª—å–Ω–æ–π",
        "—É—Å—Ç–∞–≤—à–∏–π",
        "–≤ —Ö–æ—Ä–æ—à–µ–π —Ñ–æ—Ä–º–µ",
    ],
    "hobby_sport": [
        "—Å–ø–æ—Ä—Ç",
        "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞",
        "–∏–≥—Ä–∞—Ç—å",
        "–∫–æ–º–∞–Ω–¥–∞",
        "—Å–µ—Ä–∏–∞–ª",
        "–º—É–∑—ã–∫–∞",
        "—Å–ª—É—à–∞—Ç—å",
        "—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å",
        "–ø–ª–∞–≤–∞—Ç—å",
        "–ø–µ—Ç—å",
        "–≥–∏—Ç–∞—Ä–∞",
        "–ø–∏–∞–Ω–∏–Ω–æ",
        "–≤–∏–¥–µ–æ",
        "—Ö–æ–±–±–∏",
        "—Ñ–∏–ª—å–º",
        "–≤–µ–ª–æ—Å–∏–ø–µ–¥",
        "–µ–∑–¥–∏—Ç—å –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ",
        "—Ä–∏—Å–æ–≤–∞—Ç—å",
        "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å",
        "–ø–µ—á—å",
    ],
    "colors_numbers": [
        "–∫—Ä–∞—Å–Ω—ã–π",
        "—Å–∏–Ω–∏–π",
        "–∑–µ–ª–µ–Ω—ã–π",
        "–∂–µ–ª—Ç—ã–π",
        "—á–µ—Ä–Ω—ã–π",
        "–±–µ–ª—ã–π",
        "—Å–µ—Ä—ã–π",
        "–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π",
        "–æ—Ä–∞–Ω–∂–µ–≤—ã–π",
        "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π",
        "—Ä–æ–∑–æ–≤—ã–π",
        "–Ω–æ–ª—å",
        "–æ–¥–∏–Ω",
        "–¥–≤–∞",
        "—Ç—Ä–∏",
        "—á–µ—Ç—ã—Ä–µ",
        "–ø—è—Ç—å",
        "—à–µ—Å—Ç—å",
        "—Å–µ–º—å",
        "–≤–æ—Å–µ–º—å",
        "–¥–µ–≤—è—Ç—å",
        "–¥–µ—Å—è—Ç—å",
        "–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å",
        "–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å",
        "–¥–≤–∞–¥—Ü–∞—Ç—å",
        "—Ç—Ä–∏–¥—Ü–∞—Ç—å",
        "—Å–æ—Ä–æ–∫",
        "–ø—è—Ç—å–¥–µ—Å—è—Ç",
        "—à–µ—Å—Ç–¥–µ—Å—è—Ç",
        "—Å–µ–º—å–¥–µ—Å—è—Ç",
        "–≤–æ—Å–µ–º—å–¥–µ—Å—è—Ç",
        "–¥–µ–≤—è–Ω–æ—Å—Ç–æ",
        "—Å—Ç–æ",
        "—Ü–≤–µ—Ç",
        "–Ω–æ–º–µ—Ä",
    ],
    "school_study": [
        "—à–∫–æ–ª–∞",
        "—à–∫–æ–ª—å–Ω–∏–∫",
        "—à–∫–æ–ª—å–Ω–∏—Ü–∞",
        "–∫–ª–∞—Å—Å",
        "—É—Ä–æ–∫",
        "–¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ",
        "—ç–∫–∑–∞–º–µ–Ω",
        "—Ç–µ—Å—Ç",
        "–∑–∞–Ω—è—Ç–∏–µ",
        "–∫—É—Ä—Å",
        "–ø–æ–≤—Ç–æ—Ä—è—Ç—å",
        "–æ–±—ä—è—Å–Ω—è—Ç—å",
        "–ø–æ–Ω–∏–º–∞—Ç—å",
        "—É—á–∏—Ç—å—Å—è –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ",
    ],
    "emotions_character": [
        "—Å—á–∞—Å—Ç–ª–∏–≤—ã–π",
        "–≥—Ä—É—Å—Ç–Ω—ã–π",
        "–∑–ª–æ–π",
        "—Å–ø–æ–∫–æ–π–Ω—ã–π",
        "–Ω–µ—Ä–≤–Ω—ã–π",
        "—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π",
        "–≥–æ—Ä–¥—ã–π",
        "–∑–∞—Å—Ç–µ–Ω—á–∏–≤—ã–π",
        "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π",
        "–≥–æ—Ç–æ–≤—ã–π –ø–æ–º–æ—á—å",
        "–≤–µ–∂–ª–∏–≤—ã–π",
        "–Ω–µ–≤–µ–∂–ª–∏–≤—ã–π",
        "—Å—Ç—Ä–∞–Ω–Ω—ã–π",
        "—Å–º–µ—à–Ω–æ–π",
        "—Å–µ—Ä—å–µ–∑–Ω—ã–π",
        "—Å–∫—É—á–Ω—ã–π",
        "–∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π",
        "–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π",
        "–≤–∞–∂–Ω—ã–π",
        "–ª–µ–≥–∫–∏–π",
        "—Å–ª–æ–∂–Ω—ã–π",
        "—á–µ—Å—Ç–Ω—ã–π",
        "–ª–µ–Ω–∏–≤—ã–π",
        "—Ç—Ä—É–¥–æ–ª—é–±–∏–≤—ã–π",
        "—Å–º–µ–ª—ã–π",
        "—Ç—Ä—É—Å–ª–∏–≤—ã–π",
        "—É–º–Ω—ã–π",
        "–≥–ª—É–ø—ã–π",
        "–Ω–∞–≥–ª—ã–π",
        "—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π",
        "–Ω–µ—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π",
        "—Å–∏–º–ø–∞—Ç–∏—á–Ω—ã–π",
        "–Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π",
        "—Å —á—É–≤—Å—Ç–≤–æ–º —é–º–æ—Ä–∞",
        "—É—Å–ø–µ—à–Ω—ã–π",
        "–ª—é–±–æ–ø—ã—Ç–Ω—ã–π",
        "–º–µ–¥–ª–µ–Ω–Ω—ã–π",
        "–±—ã—Å—Ç—Ä—ã–π",
        "—Å–∏–ª—å–Ω—ã–π",
        "–∑–ª–æ—Å—Ç—å",
        "—Ä–∞–¥–æ—Å—Ç—å",
        "—Å—Ç—Ä–∞—Ö",
        "—Å—é—Ä–ø—Ä–∏–∑",
        "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ",
        "—É–≤–∞–∂–µ–Ω–∏–µ",
        "—Å–æ–º–Ω–µ–Ω–∏–µ",
        "–Ω–∞–¥–µ–∂–¥–∞",
        "—Ç–µ—Ä–ø–µ–Ω–∏–µ",
    ],
    "abstract": [
        "–∏–¥–µ—è",
        "–º–µ—á—Ç–∞",
        "–∂–µ–ª–∞–Ω–∏–µ",
        "–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å",
        "–ø—Ä–æ–±–ª–µ–º–∞",
        "—Ä–µ—à–µ–Ω–∏–µ",
        "–±—É–¥—É—â–µ–µ",
        "–ø—Ä–æ—à–ª–æ–µ",
        "–Ω–∞—Å—Ç–æ—è—â–µ–µ",
        "—Å—Ç—Ä–∞–Ω–∏—Ü–∞",
        "—Å—Ç–æ—Ä–æ–Ω–∞",
        "–Ω–∞—á–∞–ª–æ",
        "–∫–æ–Ω–µ—Ü",
        "—Å–µ—Ä–µ–¥–∏–Ω–∞",
        "–ø—Ä–∏—á–∏–Ω–∞",
        "–æ–ø—ã—Ç",
        "–ø–æ–º–æ—â—å",
        "—Ü–µ–ª—å",
        "–≤—Ä–µ–º—è",
        "—Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è",
        "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
    ],
}

# –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–æ–≤–∞ –ø–æ —Ç–µ–º–∞–º
TOPIC_WORDS: Dict[str, List[Dict[str, str]]] = {k: [] for k in TOPIC_TITLES.keys()}
TOPIC_WORDS["dictionary"] = []

for w in ALL_WORDS:
    assigned = False
    ru = w["ru"].lower()
    for topic_id, kw_list in TOPIC_KEYWORDS_RU.items():
        if any(k in ru for k in kw_list):
            TOPIC_WORDS[topic_id].append(w)
            assigned = True
            break
    if not assigned:
        TOPIC_WORDS["dictionary"].append(w)

# "all" —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å–ª–æ–≤–∞
TOPIC_WORDS["all"] = ALL_WORDS

# ---------- –°–û–°–¢–û–Ø–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ----------

@dataclass
class QuizState:
    topic_id: str
    remaining: List[int] = field(default_factory=list)
    correct: int = 0
    wrong: int = 0
    current_index: int | None = None
    current_direction: str | None = None  # "de_ru" –∏–ª–∏ "ru_de"
    options: List[str] = field(default_factory=list)
    correct_option: str | None = None


USER_STATE: Dict[int, QuizState] = {}


# ---------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ----------

def build_topics_keyboard() -> InlineKeyboardMarkup:
    buttons: List[List[InlineKeyboardButton]] = []

    def add_row(tid: str):
        count = len(TOPIC_WORDS.get(tid, []))
        title = TOPIC_TITLES[tid]
        if tid != "all":
            text = f"{title} ({count})"
        else:
            text = title
        buttons.append(
            [InlineKeyboardButton(text=text, callback_data=f"topic:{tid}")]
        )

    add_row("all")
    add_row("abstract")
    add_row("verbs")
    add_row("time_calendar")
    add_row("city_transport")
    add_row("home")
    add_row("food_shop")
    add_row("animals")
    add_row("tools_house")
    add_row("computer_internet")
    add_row("personal_data")
    add_row("clothes")
    add_row("weather_nature")
    add_row("objects")
    add_row("greetings")
    add_row("jobs_work")
    add_row("family")
    add_row("dictionary")
    add_row("body_health")
    add_row("hobby_sport")
    add_row("colors_numbers")
    add_row("school_study")
    add_row("emotions_character")

    return InlineKeyboardMarkup(inline_keyboard=buttons)


def build_options_keyboard(options: List[str]) -> InlineKeyboardMarkup:
    rows: List[List[InlineKeyboardButton]] = []
    for i, opt in enumerate(options):
        rows.append(
            [InlineKeyboardButton(text=opt, callback_data=f"ans:{i}")]
        )
    return InlineKeyboardMarkup(inline_keyboard=rows)


def format_full_answer(word: Dict[str, str]) -> str:
    de = word["de"]
    tr = word["tr"]
    ru = word["ru"]
    return (
        f"{de} [{tr}] - {ru}\n"
        f"{ru} - {de} [{tr}]"
    )


def start_new_topic(user_id: int, topic_id: str) -> QuizState:
    words = TOPIC_WORDS[topic_id]
    indices = list(range(len(words)))
    random.shuffle(indices)
    state = QuizState(topic_id=topic_id, remaining=indices)
    USER_STATE[user_id] = state
    return state


def prepare_question(user_id: int) -> tuple[str, InlineKeyboardMarkup] | None:
    state = USER_STATE.get(user_id)
    if not state or not state.remaining:
        return None

    words = TOPIC_WORDS[state.topic_id]
    idx = state.remaining.pop()
    word = words[idx]

    direction = random.choice(["de_ru", "ru_de"])
    state.current_index = idx
    state.current_direction = direction

    # –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    if direction == "de_ru":
        question_text = f"–í—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π:\n\n{word['de']} [{word['tr']}]"
        correct_text = word["ru"]
    else:
        question_text = f"–í—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –Ω–µ–º–µ—Ü–∫–∏–π:\n\n{word['ru']}"
        correct_text = word["de"]

    # –Ω–∞–±–∏—Ä–∞–µ–º 3 –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞
    all_words = words
    incorrect_options: List[str] = []
    pool_indices = [i for i in range(len(all_words)) if i != idx]
    random.shuffle(pool_indices)
    for i in pool_indices:
        w = all_words[i]
        opt = w["ru"] if direction == "de_ru" else w["de"]
        if opt != correct_text and opt not in incorrect_options:
            incorrect_options.append(opt)
        if len(incorrect_options) == 3:
            break

    options = incorrect_options + [correct_text]
    random.shuffle(options)
    state.options = options
    state.correct_option = correct_text

    kb = build_options_keyboard(options)
    return question_text, kb


# ---------- –•–ï–ù–î–õ–ï–†–´ ----------

@dp.message(CommandStart())
async def cmd_start(message: Message):
    user_id = message.from_user.id
    USER_STATE.pop(user_id, None)
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–µ–º–µ—Ü–∫–∏—Ö —Å–ª–æ–≤.\n\n"
        "–í—ã–±–µ—Ä–∏ —Ç–µ–º—É:",
        reply_markup=build_topics_keyboard(),
    )


@dp.message(Command("menu"))
async def cmd_menu(message: Message):
    await message.answer(
        "–í—ã–±–µ—Ä–∏ —Ç–µ–º—É:",
        reply_markup=build_topics_keyboard(),
    )


@dp.callback_query(F.data.startswith("topic:"))
async def cb_choose_topic(callback: CallbackQuery):
    user_id = callback.from_user.id
    topic_id = callback.data.split(":", 1)[1]

    if topic_id not in TOPIC_TITLES:
        await callback.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–º–∞")
        return

    state = start_new_topic(user_id, topic_id)
    words_count = len(TOPIC_WORDS[topic_id])

    if not state.remaining:
        await callback.message.edit_text("–í —ç—Ç–æ–π —Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤.")
        await callback.answer()
        return

    await callback.message.edit_text(
        f"–¢–µ–º–∞: {TOPIC_TITLES[topic_id]}\n–°–ª–æ–≤ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ: {words_count}\n\n"
        f"–ù–∞—á–∏–Ω–∞–µ–º!"
    )

    q = prepare_question(user_id)
    if q is None:
        await callback.message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å.")
    else:
        text, kb = q
        await callback.message.answer(text, reply_markup=kb)
    await callback.answer()


@dp.callback_query(F.data.startswith("ans:"))
async def cb_answer(callback: CallbackQuery):
    user_id = callback.from_user.id
    state = USER_STATE.get(user_id)

    if not state or state.current_index is None:
        await callback.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç–µ–º—É —á–µ—Ä–µ–∑ /start –∏–ª–∏ /menu")
        return

    try:
        chosen_i = int(callback.data.split(":", 1)[1])
    except ValueError:
        await callback.answer("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞")
        return

    if chosen_i < 0 or chosen_i >= len(state.options):
        await callback.answer("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞")
        return

    chosen_text = state.options[chosen_i]
    words = TOPIC_WORDS[state.topic_id]
    word = words[state.current_index]

    is_correct = chosen_text == state.correct_option

    if is_correct:
        state.correct += 1
        prefix = "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!\n"
    else:
        state.wrong += 1
        prefix = "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.\n"

    full_answer = format_full_answer(word)
    await callback.message.answer(prefix + full_answer)

    # —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    if not state.remaining:
        total = state.correct + state.wrong
        await callback.message.answer(
            f"–¢–µ–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n"
            f"–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {total}\n"
            f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: {state.correct}\n"
            f"–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: {state.wrong}\n\n"
            f"–ß—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —Ç–µ–º—É, –Ω–∞–ø–∏—à–∏ /menu"
        )
        USER_STATE.pop(user_id, None)
    else:
        q = prepare_question(user_id)
        if q is None:
            await callback.message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.")
        else:
            text, kb = q
            await callback.message.answer(text, reply_markup=kb)

    await callback.answer()


# ---------- –ó–ê–ü–£–°–ö ----------

async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
