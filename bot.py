import asyncio
import json
import os
import random
from collections import defaultdict
from typing import Dict, List, Any

from aiogram import Bot, Dispatcher, F
from aiogram.filters import CommandStart, Command
from aiogram.types import (
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)

# ============================================================
# –ù–ê–°–¢–†–û–ô–ö–ò
# ============================================================

TOKEN = os.getenv("BOT_TOKEN", "8583421204:AAHB_2Y8RjDQHDQLcqDLJkYfiP6oBqq3SyE")
WORDS_FILE = "words.json"

MODE_DE_RU = "de_ru"
MODE_RU_DE = "ru_de"
MODE_MIXED = "mixed"

THEME_ALL = "all"
THEME_OTHER = "other"

# ============================================================
# –ó–ê–ì–†–£–ó–ö–ê –°–õ–û–í –ò –†–ê–ó–ë–ò–ï–ù–ò–ï –ü–û –¢–ï–ú–ê–ú
# ============================================================

WORDS: List[Dict[str, str]] = []
TOPICS: Dict[str, Dict[str, Any]] = {}

TOPIC_RULES = [
    # –ø—Ä–∞–≤–∏–ª–∞ —Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ —Ä–∞–Ω—å—à–µ ‚Äì —É–∫–æ—Ä–æ—á–µ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    {
        "id": "greetings",
        "name": "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã",
        "keywords": [
            "–ø—Ä–∏–≤–µ—Ç",
            "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å",
            "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä",
            "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
            "–¥–æ–±—Ä–æ–π –Ω–æ—á–∏",
            "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è",
            "–∫–∞–∫ –¥–µ–ª–∞",
            "—Å–ø–∞—Å–∏–±–æ",
            "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞",
            "–æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ",
            "—Ö–æ—Ä–æ—à–æ",
            "–Ω–µ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ",
            "–≤–µ—Ä–Ω–æ",
            "–ø—Ä–∞–≤–∏–ª—å–Ω–æ",
            "–æ–∫–µ–π",
            "–º–Ω–µ –∂–∞–ª—å",
            "–¥–∞",
            "–Ω–µ—Ç",
        ],
    },
    {
        "id": "personal",
        "name": "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
        "keywords": [
            "–∏–º—è",
            "—Ñ–∞–º–∏–ª–∏—è",
            "—É–ª–∏—Ü–∞",
            "–∞–¥—Ä–µ—Å",
            "–Ω–æ–º–µ—Ä –¥–æ–º–∞",
            "–ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å",
            "–º–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è",
            "–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
            "–ø–æ—á—Ç–∞",
            "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å",
            "–ø–æ–¥–ø–∏—Å—å",
        ],
    },
    {
        "id": "family",
        "name": "–°–µ–º—å—è –∏ –ª—é–¥–∏",
        "keywords": [
            "—Å–µ–º—å—è",
            "–º–∞—Ç—å",
            "–æ—Ç–µ—Ü",
            "—Å—ã–Ω",
            "–¥–æ—á—å",
            "–±—Ä–∞—Ç—å—è –∏ —Å–µ—Å—Ç—Ä—ã",
            "–±–∞–±—É—à–∫–∞",
            "–¥–µ–¥",
            "–≤–Ω—É–∫",
            "–≤–Ω—É—á–∫–∞",
            "—Ç–µ—Ç—è",
            "–¥—è–¥—è",
            "–¥–≤–æ—é—Ä–æ–¥–Ω—ã–π",
            "–¥—Ä—É–≥",
            "–ø–æ–¥—Ä—É–≥–∞",
            "–∫–æ–ª–ª–µ–≥–∞",
            "–∂–µ–Ω–∞—Ç",
            "–∑–∞–º—É–∂–µ–º",
            "—Ö–æ–ª–æ—Å—Ç",
            "—Ä–∞–∑–≤–µ–¥–µ–Ω",
            "–≤–¥–æ–≤–µ—Ü",
            "–≤–¥–æ–≤–∞",
            "—Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ",
            "–≤–æ–∑—Ä–∞—Å—Ç",
        ],
    },
    {
        "id": "verbs",
        "name": "–ì–ª–∞–≥–æ–ª—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è",
        "keywords": [
            "–±—ã—Ç—å",
            "–∏–º–µ—Ç—å",
            "–∂–∏—Ç—å",
            "–≥–æ–≤–æ—Ä–∏—Ç—å",
            "—É—á–∏—Ç—å—Å—è",
            "—Ä–∞–±–æ—Ç–∞—Ç—å",
            "–∏—Å–∫–∞—Ç—å",
            "–∏–¥—Ç–∏",
            "–∑–≤–æ–Ω–∏—Ç—å",
            "–¥—É–º–∞—Ç—å",
            "–¥–µ–ª–∞—Ç—å",
            "–ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å –ø–æ –±—É–∫–≤–∞–º",
            "–ª—é–±–∏—Ç—å",
            "—Ö–æ—Ç–µ–ª –±—ã",
            "–Ω—É–∂–¥–∞—Ç—å—Å—è",
            "–±—Ä–∞—Ç—å",
            "–¥–∞–≤–∞—Ç—å",
            "–ø–æ–∫—É–ø–∞—Ç—å",
            "—á–∏–Ω–∏—Ç—å",
            "—Ä–µ–∑–∞—Ç—å",
            "–≥–æ—Ç–æ–≤–∏—Ç—å",
            "–ø–µ—á—å",
            "–æ—Ç–∫—Ä—ã–≤–∞—Ç—å",
            "–∑–∞–∫—Ä—ã–≤–∞—Ç—å",
            "–Ω–æ—Å–∏—Ç—å",
            "–±–µ–∂–∞—Ç—å",
            "–ø—Ä—ã–≥–∞—Ç—å",
            "—Å–∏–¥–µ—Ç—å",
            "—Å—Ç–æ—è—Ç—å",
            "–ª–µ–∂–∞—Ç—å",
            "–ø–∞–¥–∞—Ç—å",
            "–∑–∞–±—ã–≤–∞—Ç—å",
            "–≤—Å–ø–æ–º–∏–Ω–∞—Ç—å",
            "–∂–¥–∞—Ç—å",
            "–º—ã—Ç—å",
            "—É–±–∏—Ä–∞—Ç—å",
        ],
    },
    {
        "id": "professions",
        "name": "–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞",
        "keywords": [
            "–≤—Ä–∞—á",
            "—É—á–∏—Ç–µ–ª—å",
            "–∏–Ω–∂–µ–Ω–µ—Ä",
            "–ø–æ–≤–∞—Ä",
            "–º–µ–¥–±—Ä–∞—Ç",
            "–º–µ–¥—Å–µ—Å—Ç—Ä–∞",
            "—Ç–∞–∫—Å–∏—Å—Ç",
            "–ø—Ä–æ–¥–∞–≤–µ—Ü",
            "–ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä",
            "–ø–µ–≤–µ—Ü",
            "–∞–∫—Ç—Ä–∏—Å–∞",
            "–∞–∫—Ç—ë—Ä",
            "—ç–ª–µ–∫—Ç—Ä–æ–Ω—â–∏–∫",
            "–¥–æ–º–æ—Ö–æ–∑—è–∏–Ω",
            "–¥–æ–º–æ—Ö–æ–∑—è–π–∫–∞",
            "–ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π",
            "—Å—Ç—É–¥–µ–Ω—Ç",
            "—Ä–∞–±–æ—Ç–∞",
            "–ø—Ä–æ—Ñ–µ—Å—Å–∏—è",
            "–Ω–∞—á–∞–ª—å–Ω–∏–∫",
            "–∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É",
            "—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ",
            "—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è",
            "–∑–∞—Ä–ø–ª–∞—Ç–∞",
            "–æ–∫–ª–∞–¥",
            "–æ—Ñ–∏—Å",
            "—Ñ–∏—Ä–º–∞",
            "–∫–æ–º–∞–Ω–¥–∞",
            "—Å–æ–≤–µ—â–∞–Ω–∏–µ",
            "–æ–ø—Ç–∏–∫",
            "–ø–µ–∫–∞—Ä—å",
            "–º—è—Å–Ω–∏–∫",
            "–º–µ—Ö–∞–Ω–∏–∫",
            "—ç–ª–µ–∫—Ç—Ä–∏–∫",
            "–º–∞–ª—è—Ä",
            "–ø–æ—Ä—Ç–Ω–æ–π",
            "—Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã",
            "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫",
            "–¥–æ—Å—Ç–∞–≤–∫–∞",
            "–∑–∞–∫–∞–∑",
            "–∫–æ–Ω—Ç—Ä–∞–∫—Ç",
            "—Å–∫–∏–¥–∫–∞",
            "—Å–µ—Ä–≤–∏—Å",
        ],
    },
    {
        "id": "school",
        "name": "–®–∫–æ–ª–∞ –∏ —É—á—ë–±–∞",
        "keywords": [
            "—à–∫–æ–ª–∞",
            "—à–∫–æ–ª—å–Ω–∏–∫",
            "—à–∫–æ–ª—å–Ω–∏—Ü–∞",
            "–∫–ª–∞—Å—Å",
            "—É—Ä–æ–∫",
            "–¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ",
            "—ç–∫–∑–∞–º–µ–Ω",
            "—Ç–µ—Å—Ç",
            "–ø–æ–≤—Ç–æ—Ä—è—Ç—å",
            "–æ–±—ä—è—Å–Ω—è—Ç—å",
            "–ø–æ–Ω–∏–º–∞—Ç—å",
            "–∫—É—Ä—Å",
            "–∫—É—Ä—Å –Ω–µ–º–µ—Ü–∫–æ–≥–æ",
            "—É—á–∏—Ç—å—Å—è –≤ –≤—É–∑–µ",
            "—É—á–∏—Ç—å—Å—è –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ",
            "—É—á–∏—Ç—å—Å—è",
        ],
    },
    {
        "id": "objects",
        "name": "–ü—Ä–µ–¥–º–µ—Ç—ã –∏ –≤–µ—â–∏",
        "keywords": [
            "–∫–Ω–∏–≥–∞",
            "—Ç–µ—Ç—Ä–∞–¥—å",
            "–±—É–º–∞–≥–∞",
            "–∫–∞—Ä–∞–Ω–¥–∞—à",
            "—Ä—É—á–∫–∞",
            "–ª–∏–Ω–µ–π–∫–∞",
            "–∫–∞–º–µ—Ä–∞",
            "–ø—Ä–∏–Ω—Ç–µ—Ä",
            "–Ω–æ—É—Ç–±—É–∫",
            "—Ç–µ–ª–µ—Ñ–æ–Ω",
            "—Å—É–º–∫–∞",
            "—Ä—é–∫–∑–∞–∫",
            "–∫–æ—à–µ–ª–µ–∫",
            "–∫–ª—é—á",
            "–∫–ª–µ–π",
            "–Ω–æ–∂–Ω–∏—Ü—ã",
            "–∑–æ–Ω—Ç",
            "–æ—á–∫–∏",
            "–∑–∞–∂–∏–≥–∞–ª–∫–∞",
            "–≥–∞–∑–µ—Ç–∞",
            "—á–∞—à–∫–∞",
            "—á–µ–º–æ–¥–∞–Ω",
            "–ø—ã–ª–µ—Å–æ—Å",
            "–≤–µ–¥—Ä–æ",
            "–≥—É–±–∫–∞",
            "—Ç—Ä—è–ø–∫–∞",
            "—Ä–æ–∑–µ—Ç–∫–∞",
            "–ª–∞–º–ø–æ—á–∫–∞",
            "–º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞",
            "—á–∞–π–Ω–∏–∫",
            "–∫–∞—Å—Ç—Ä—é–ª—è",
            "—Å–∫–æ–≤–æ—Ä–æ–¥–∞",
            "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
        ],
    },
    {
        "id": "time",
        "name": "–í—Ä–µ–º—è, –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å",
        "keywords": [
            "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
            "–≤—Ç–æ—Ä–Ω–∏–∫",
            "—Å—Ä–µ–¥–∞",
            "—á–µ—Ç–≤–µ—Ä–≥",
            "–ø—è—Ç–Ω–∏—Ü–∞",
            "—Å—É–±–±–æ—Ç–∞",
            "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
            "—É—Ç—Ä–æ",
            "–≤–µ—á–µ—Ä",
            "–Ω–æ—á—å",
            "–ø–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è",
            "–≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è",
            "—á–∞—Å",
            "–¥–µ–Ω—å",
            "–Ω–µ–¥–µ–ª—è",
            "–º–µ—Å—è—Ü",
            "–≥–æ–¥",
            "–º–∞—Ä—Ç",
            "–∞–ø—Ä–µ–ª—å",
            "–º–∞–π",
            "–∏—é–Ω—å",
            "–∏—é–ª—å",
            "–∞–≤–≥—É—Å—Ç",
            "—Å–µ–Ω—Ç—è–±—Ä—å",
            "–æ–∫—Ç—è–±—Ä—å",
            "–Ω–æ—è–±—Ä—å",
            "–¥–µ–∫–∞–±—Ä—å",
            "–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å",
        ],
    },
    {
        "id": "numbers_colors",
        "name": "–ß–∏—Å–ª–∞ –∏ —Ü–≤–µ—Ç–∞",
        "keywords": [
            "–Ω–æ–ª—å",
            "–æ–¥–∏–Ω",
            "–¥–≤–∞",
            "—Ç—Ä–∏",
            "—á–µ—Ç—ã—Ä–µ",
            "–ø—è—Ç—å",
            "—à–µ—Å—Ç—å",
            "—Å–µ–º—å",
            "–≤–æ—Å–µ–º—å",
            "–¥–µ–≤—è—Ç—å",
            "–¥–µ—Å—è—Ç—å",
            "–¥–≤–∞–¥—Ü–∞—Ç—å",
            "—Ç—Ä–∏–¥—Ü–∞—Ç—å",
            "—Å–æ—Ä–æ–∫",
            "–ø—è—Ç—å–¥–µ—Å—è—Ç",
            "—à–µ—Å—Ç—å–¥–µ—Å—è—Ç",
            "—Å–µ–º—å–¥–µ—Å—è—Ç",
            "–≤–æ—Å–µ–º—å–¥–µ—Å—è—Ç",
            "–¥–µ–≤—è–Ω–æ—Å—Ç–æ",
            "—Å—Ç–æ",
            "–∫—Ä–∞—Å–Ω—ã–π",
            "—Å–∏–Ω–∏–π",
            "–∑–µ–ª—ë–Ω—ã–π",
            "–∂–µ–ª—Ç—ã–π",
            "—á—ë—Ä–Ω—ã–π",
            "–±–µ–ª—ã–π",
            "—Å–µ—Ä—ã–π",
            "–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π",
            "–æ—Ä–∞–Ω–∂–µ–≤—ã–π",
            "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π",
            "—Ä–æ–∑–æ–≤—ã–π",
        ],
    },
    {
        "id": "food",
        "name": "–ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏",
        "keywords": [
            "–∫–æ—Ñ–µ",
            "—á–∞–π",
            "–º–æ–ª–æ–∫–æ",
            "–≤–æ–¥–∞",
            "—Å–æ–∫",
            "–ø–∏–≤–æ",
            "—Ö–ª–µ–±",
            "–±—É–ª–æ—á–∫–∞",
            "–∫—Ä—É–∞—Å—Å–∞–Ω",
            "—è–π—Ü–æ",
            "—è–±–ª–æ–∫–æ",
            "–≥—Ä—É—à–∞",
            "—Ñ—Ä—É–∫—Ç—ã",
            "–º—é—Å–ª–∏",
            "–π–æ–≥—É—Ä—Ç",
            "—Ç–æ—Ä—Ç",
            "–∫–æ–ª–±–∞—Å–∞",
            "—Å—ã—Ä",
            "–∫–∞—Ä—Ç–æ—à–∫–∞",
            "–≤–µ—Ç—á–∏–Ω–∞",
            "—Å–∞–ª–∞—Ç",
            "–ø–æ–º–∏–¥–æ—Ä",
            "—Å–ª–∏–≤–∫–∏",
            "–±–∞–Ω–∞–Ω",
            "–ø—Ä–æ–¥—É–∫—Ç –ø–∏—Ç–∞–Ω–∏—è",
            "–æ–≤–æ—â–∏",
            "–º—è—Å–æ",
            "–Ω–∞–ø–∏—Ç–æ–∫",
            "–¥–µ—Å–µ—Ä—Ç",
            "–µ–¥–∞",
            "–ª—é–±–∏–º–∞—è –µ–¥–∞",
            "—Ä–∏—Å",
            "—à–æ–∫–æ–ª–∞–¥",
            "–º–æ—Ä–æ–∂–µ–Ω–æ–µ",
            "—Å—É–ø",
            "—É–∂–∏–Ω",
            "–æ–±–µ–¥",
            "–º–∞—Å–ª–æ",
            "—Ä—ã–±–∞",
        ],
    },
    {
        "id": "shopping",
        "name": "–ü–æ–∫—É–ø–∫–∏ –∏ –¥–µ–Ω—å–≥–∏",
        "keywords": [
            "–ø–æ–∫—É–ø–∫–∞",
            "–µ–≤—Ä–æ",
            "—Ü–µ–Ω—Ç",
            "—Å—Ç–æ–∏—Ç",
            "–∫–ª–∏–µ–Ω—Ç",
            "–∫–ª–∏–µ–Ω—Ç–∫–∞",
            "–ø–∞–∫–µ—Ç",
            "–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å",
            "–º–∞–≥–∞–∑–∏–Ω",
            "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç",
            "—Ä—ã–Ω–æ–∫",
            "—Å—á–µ—Ç",
            "—Å–∫–∏–¥–∫–∞",
            "–∑–∞–∫–∞–∑",
        ],
    },
    {
        "id": "city_transport",
        "name": "–ì–æ—Ä–æ–¥ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
        "keywords": [
            "–≥–æ—Ä–æ–¥",
            "–¥–µ—Ä–µ–≤–Ω—è",
            "—É–ª–∏—Ü–∞",
            "–ø–ª–æ—â–∞–¥—å",
            "–ø–∞—Ä–∫",
            "–º–æ—Å—Ç",
            "–≤–æ–∫–∑–∞–ª",
            "–∞—ç—Ä–æ–ø–æ—Ä—Ç",
            "–æ—Å—Ç–∞–Ω–æ–≤–∫–∞",
            "–º–µ—Ç—Ä–æ",
            "–ø–æ–µ–∑–¥",
            "–∞–≤—Ç–æ–±—É—Å",
            "—Ç–∞–∫—Å–∏",
            "–ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫",
            "—Å–≤–µ—Ç–æ—Ñ–æ—Ä",
            "–∞–ø—Ç–µ–∫–∞",
            "–±–∞–Ω–∫",
            "–ø–æ—á—Ç–∞",
            "—à–∫–æ–ª–∞",
            "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
            "–¥–µ—Ç—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞",
            "–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä",
            "—Ç–µ–∞—Ç—Ä",
            "–º—É–∑–µ–π",
            "–ø–æ—Ä—Ç",
            "–ø–∞—Ä–∫–æ–≤–∫–∞",
        ],
    },
    {
        "id": "home",
        "name": "–î–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞ –∏ –º–µ–±–µ–ª—å",
        "keywords": [
            "–¥–æ–º",
            "–∫–≤–∞—Ä—Ç–∏—Ä–∞",
            "–∫–æ–º–Ω–∞—Ç–∞",
            "–≥–æ—Å—Ç–∏–Ω–∞—è",
            "—Å–ø–∞–ª—å–Ω—è",
            "–∫—É—Ö–Ω—è",
            "–≤–∞–Ω–Ω–∞—è",
            "—Ç—É–∞–ª–µ—Ç",
            "–∫–æ—Ä–∏–¥–æ—Ä",
            "–±–∞–ª–∫–æ–Ω",
            "—Å–∞–¥",
            "–æ–∫–Ω–æ",
            "–¥–≤–µ—Ä—å",
            "—Å—Ç–æ–ª",
            "—Å—Ç—É–ª",
            "–∫—Ä–æ–≤–∞—Ç—å",
            "—à–∫–∞—Ñ",
            "–ª–∞–º–ø–∞",
            "–∫–æ–≤–µ—Ä",
            "—Ç–µ–ª–µ–≤–∏–∑–æ—Ä",
            "—Å—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞",
            "—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫",
            "–ø–ª–∏—Ç–∞",
            "–¥—É—Ö–æ–≤–∫–∞",
            "–¥—É—à",
            "–≤–∞–Ω–Ω–∞",
            "–¥–∏–≤–∞–Ω",
            "–∑–µ—Ä–∫–∞–ª–æ",
            "—à—Ç–æ—Ä–∞",
            "—Å—Ç–µ–Ω–∞",
            "–ø–æ–ª",
            "–ø–æ—Ç–æ–ª–æ–∫",
        ],
    },
    {
        "id": "nature_animals_weather",
        "name": "–ü—Ä–∏—Ä–æ–¥–∞, –∂–∏–≤–æ—Ç–Ω—ã–µ –∏ –ø–æ–≥–æ–¥–∞",
        "keywords": [
            "–¥–µ—Ä–µ–≤–æ",
            "—Ü–≤–µ—Ç–æ–∫",
            "—Å–æ–ª–Ω—Ü–µ",
            "–ø–æ–≥–æ–¥–∞",
            "–∏–¥–µ—Ç –¥–æ–∂–¥—å",
            "–∏–¥–µ—Ç —Å–Ω–µ–≥",
            "—Ç–µ–ø–ª–æ",
            "—Ö–æ–ª–æ–¥–Ω–æ",
            "–ª–µ—Å",
            "—Ä–µ–∫–∞",
            "—Ä—É—á–µ–π",
            "—Ö–æ–ª–º",
            "–ª—É–≥",
            "–ø–æ–ª–µ",
            "—Å–∫–∞–ª–∞",
            "–ø–ª—è–∂",
            "—Ä–∞–¥—É–≥–∞",
            "—à—Ç–æ—Ä–º",
            "–Ω–µ–±–æ",
            "–æ–±–ª–∞–∫–æ",
            "–ø—Ä–∏—Ä–æ–¥–∞",
            "–∑–µ–º–ª—è",
            "–ø–ª–∞–Ω–µ—Ç–∞",
            "–≤–æ–∑–¥—É—Ö",
            "–∫–ª–∏–º–∞—Ç",
            "—Ç—É–º–∞–Ω",
            "–≤–µ—Ç–µ—Ä",
            "—Å–æ–±–∞–∫–∞",
            "–∫–æ—à–∫–∞",
            "–ø—Ç–∏—Ü–∞",
            "–ª–æ—à–∞–¥—å",
            "–∫–æ—Ä–æ–≤–∞",
            "—Å–≤–∏–Ω—å—è",
            "–æ–≤—Ü–∞",
            "–º—ã—à—å",
            "–º–µ–¥–≤–µ–¥—å",
            "–ª–µ–≤",
            "–∑–º–µ—è",
            "—Ç–∏–≥—Ä",
            "–∑–∞—è—Ü",
            "–æ–±–µ–∑—å—è–Ω–∞",
            "–≤–µ—Ä–±–ª—é–¥",
            "–≤–æ–ª–∫",
            "–ª–∏—Å–∞",
            "—É—Ç–∫–∞",
        ],
    },
    {
        "id": "clothes",
        "name": "–û–¥–µ–∂–¥–∞",
        "keywords": [
            "—Ä—É–±–∞—à–∫–∞",
            "—à—Ç–∞–Ω—ã",
            "–¥–∂–∏–Ω—Å—ã",
            "—Ñ—É—Ç–±–æ–ª–∫–∞",
            "—Å–≤–∏—Ç–µ—Ä",
            "–∫—É—Ä—Ç–∫–∞",
            "–ø–∞–ª—å—Ç–æ",
            "–±–ª—É–∑–∫–∞",
            "—é–±–∫–∞",
            "–ø–ª–∞—Ç—å–µ",
            "–æ–±—É–≤—å",
            "–±–æ—Ç–∏–Ω–æ–∫",
            "–Ω–æ—Å–∫–∏",
            "—Å–∞–ø–æ–≥–∏",
            "—Ä–µ–º–µ–Ω—å",
            "—à–ª—è–ø–∞",
            "—à–∞–ø–∫–∞",
            "—à–∞—Ä—Ñ",
            "–ø–µ—Ä—á–∞—Ç–∫–∏",
            "—Ç—Ä—É—Å—ã",
            "–ª–∏—Ñ—á–∏–∫",
            "–∫–æ—Å—Ç—é–º",
            "–æ–¥–µ–∂–¥–∞",
            "–º–æ–¥–∞",
            "—Ç–∫–∞–Ω—å",
            "–ø—É–≥–æ–≤–∏—Ü–∞",
            "–º–æ–ª–Ω–∏—è",
            "—Ä–∞–∑–º–µ—Ä",
        ],
    },
    {
        "id": "body_health",
        "name": "–¢–µ–ª–æ –∏ –∑–¥–æ—Ä–æ–≤—å–µ",
        "keywords": [
            "–≥–æ–ª–æ–≤–∞",
            "–ª–∏—Ü–æ",
            "–ª–æ–±",
            "–≥–ª–∞–∑",
            "–±—Ä–æ–≤—å",
            "–Ω–æ—Å",
            "—Ä–æ—Ç",
            "–∑—É–±—ã",
            "—É—Ö–æ",
            "–≤–æ–ª–æ—Å—ã",
            "—à–µ—è",
            "–ø–ª–µ—á–æ",
            "—Ä—É–∫–∞",
            "–∫–∏—Å—Ç—å",
            "–ø–∞–ª–µ—Ü",
            "–≥—Ä—É–¥—å",
            "—Å–ø–∏–Ω–∞",
            "–∂–∏–≤–æ—Ç",
            "–Ω–æ–≥–∞",
            "—Å—Ç–æ–ø–∞",
            "–∫–æ–ª–µ–Ω–æ",
            "–±–æ–ª—å–Ω–∏—Ü–∞",
            "–ø—Ä–∏—ë–º —É –≤—Ä–∞—á–∞",
            "–ø–∞—Ü–∏–µ–Ω—Ç",
            "–±–æ–ª—å",
            "–ø—Ä–æ—Å—Ç—É–¥–∞",
            "–≥—Ä–∏–ø–ø",
            "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞",
            "—Ç–∞–±–ª–µ—Ç–∫–∞",
            "–ª–µ–∫–∞—Ä—Å—Ç–≤–æ",
            "–º–∞–∑—å",
            "–±–∏–Ω—Ç",
            "–∑–¥–æ—Ä–æ–≤—ã–π",
            "–±–æ–ª—å–Ω–æ–π",
            "—É—Å—Ç–∞–≤—à–∏–π",
            "–∑–¥–æ—Ä–æ–≤—å–µ",
            "–∫—Ä–æ–≤—å",
            "–ª–µ–≥–∫–æ–µ",
            "–ø–µ—á–µ–Ω—å",
            "–º—ã—à—Ü–∞",
        ],
    },
    {
        "id": "feelings_character",
        "name": "–ß—É–≤—Å—Ç–≤–∞ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä",
        "keywords": [
            "—Å—á–∞—Å—Ç–ª–∏–≤—ã–π",
            "–≥—Ä—É—Å—Ç–Ω—ã–π",
            "–∑–ª–æ–π",
            "—Å–ø–æ–∫–æ–π–Ω—ã–π",
            "–Ω–µ—Ä–≤–Ω—ã–π",
            "—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π",
            "–≥–æ—Ä–¥—ã–π",
            "–∑–∞—Å—Ç–µ–Ω—á–∏–≤—ã–π",
            "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π",
            "–≥–æ—Ç–æ–≤—ã–π –ø–æ–º–æ—á—å",
            "–≤–µ–∂–ª–∏–≤—ã–π",
            "–Ω–µ–≤–µ–∂–ª–∏–≤—ã–π",
            "—Å—Ç—Ä–∞–Ω–Ω—ã–π",
            "—Å–º–µ—à–Ω–æ–π",
            "—Å–µ—Ä—å–µ–∑–Ω—ã–π",
            "—Å–∫—É—á–Ω—ã–π",
            "–∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π",
            "–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π",
            "–≤–∞–∂–Ω—ã–π",
            "–ª–µ–≥–∫–∏–π",
            "—Å–ª–æ–∂–Ω—ã–π",
            "—á–µ—Å—Ç–Ω—ã–π",
            "–ª–µ–Ω–∏–≤—ã–π",
            "—Ç—Ä—É–¥–æ–ª—é–±–∏–≤—ã–π",
            "—Å–º–µ–ª—ã–π",
            "—Ç—Ä—É—Å–ª–∏–≤—ã–π",
            "—É–º–Ω—ã–π",
            "–≥–ª—É–ø—ã–π",
            "–Ω–∞–≥–ª—ã–π",
            "—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π",
            "–Ω–µ—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π",
            "—Å–∏–º–ø–∞—Ç–∏—á–Ω—ã–π",
            "—É—Å–ø–µ—à–Ω—ã–π",
            "–ª—é–±–æ–ø—ã—Ç–Ω—ã–π",
            "–º–µ–¥–ª–µ–Ω–Ω—ã–π",
            "–±—ã—Å—Ç—Ä—ã–π",
            "–∑–ª–æ—Å—Ç—å",
            "—Ä–∞–¥–æ—Å—Ç—å",
            "—Å—Ç—Ä–∞—Ö",
            "—Å–º–µ–ª–æ—Å—Ç—å",
            "—Å—é—Ä–ø—Ä–∏–∑",
            "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ",
            "—É–≤–∞–∂–µ–Ω–∏–µ",
            "—Å–æ–º–Ω–µ–Ω–∏–µ",
            "–Ω–∞–¥–µ–∂–¥–∞",
            "—Ç–µ—Ä–ø–µ–Ω–∏–µ",
        ],
    },
    {
        "id": "tech_internet",
        "name": "–ö–æ–º–ø—å—é—Ç–µ—Ä –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
        "keywords": [
            "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–Ω–æ—É—Ç–±—É–∫",
            "–º—ã—à—å",
            "–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞",
            "—ç–∫—Ä–∞–Ω",
            "—Ñ–∞–π–ª",
            "–ø–∞–ø–∫–∞",
            "—Å–æ—Ö—Ä–∞–Ω—è—Ç—å",
            "—É–¥–∞–ª—è—Ç—å",
            "–ø–∞—Ä–æ–ª—å",
            "–≤—Ö–æ–¥–∏—Ç—å",
            "–≤—ã—Ö–æ–¥–∏—Ç—å (–∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞)",
            "–ø—Ä–æ–≥—Ä–∞–º–º–∞",
            "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
            "—Å–∫–∞—á–∏–≤–∞—Ç—å",
            "–∑–∞–≥—Ä—É–∂–∞—Ç—å",
            "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
            "–≤–∞–π-—Ñ–∞–π",
            "—Å–∏–¥–µ—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ",
            "–≤–∏–¥–µ–æ",
        ],
    },
    {
        "id": "travel_leisure",
        "name": "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è",
        "keywords": [
            "–æ—Ç–ø—É—Å–∫",
            "–ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å",
            "–ø–æ–µ–∑–¥–∫–∞",
            "–æ—Ç–µ–ª—å",
            "–Ω–æ–º–µ—Ä (–∫–æ–º–Ω–∞—Ç–∞)",
            "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
            "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å",
            "—Ä–µ—Å–µ–ø—à–µ–Ω",
            "–ø–ª—è–∂",
            "–º–æ—Ä–µ",
            "–æ–∑–µ—Ä–æ",
            "–≥–æ—Ä–∞",
            "–æ—Å—Ç—Ä–æ–≤",
            "–ø–µ—Ä–µ–ª–µ—Ç",
            "—Ä–µ–π—Å",
            "–ø–∞—Å–ø–æ—Ä—Ç",
            "–±–∞–≥–∞–∂",
            "—Å–ø–æ—Ä—Ç",
            "—Ö–æ–±–±–∏",
            "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞",
            "—Å–µ—Ä–∏—è",
            "—Ñ–∏–ª—å–º",
            "–≤–µ–ª–æ—Å–∏–ø–µ–¥",
            "–∏–≥—Ä–∞",
            "–≤—ã–∏–≥—Ä—ã–≤–∞—Ç—å",
            "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è",
            "–º—É–∑—ã–∫–∞",
            "—Å–ª—É—à–∞—Ç—å",
            "—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å",
            "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å",
            "–ø–∏–∞–Ω–∏–Ω–æ",
            "—Ä–∏—Å–æ–≤–∞—Ç—å",
            "—à–∏—Ç—å",
            "–ø–ª–∞–≤–∞—Ç—å",
            "–ø–µ—Ç—å",
            "–≥–∏—Ç–∞—Ä–∞",
            "–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è",
            "–∫–ª—É–±",
            "–∫–æ–º–∞–Ω–¥–∞",
        ],
    },
]


def load_words():
    global WORDS, TOPICS
    with open(WORDS_FILE, "r", encoding="utf-8") as f:
        WORDS = json.load(f)

    topics_words: Dict[str, List[int]] = defaultdict(list)

    for idx, w in enumerate(WORDS):
        text = (w.get("de", "") + " " + w.get("ru", "")).lower()
        assigned = False
        for rule in TOPIC_RULES:
            if any(kw in text for kw in rule["keywords"]):
                topics_words[rule["id"]].append(idx)
                assigned = True
                break
        if not assigned:
            topics_words[THEME_OTHER].append(idx)

    TOPICS = {}
    for rule in TOPIC_RULES:
        ids = topics_words.get(rule["id"], [])
        if ids:
            TOPICS[rule["id"]] = {
                "id": rule["id"],
                "name": rule["name"],
                "words": ids,
                "count": len(ids),
            }

    other_ids = topics_words.get(THEME_OTHER, [])
    if other_ids:
        TOPICS[THEME_OTHER] = {
            "id": THEME_OTHER,
            "name": "–†–∞–∑–Ω–æ–µ",
            "words": other_ids,
            "count": len(other_ids),
        }


# ============================================================
# –°–û–°–¢–û–Ø–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
# ============================================================

# user_id -> state
USER_STATE: Dict[int, Dict[str, Any]] = {}


def init_state() -> Dict[str, Any]:
    return {
        "mode": MODE_DE_RU,
        "theme": THEME_ALL,
        "remaining": [],   # —Å–ø–∏—Å–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤ —Å–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ—â—ë –Ω–µ –∑–∞–¥–∞–≤–∞–ª–∏ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ
        "correct": 0,
        "wrong": 0,
        "total": 0,
    }


def get_user_state(user_id: int) -> Dict[str, Any]:
    if user_id not in USER_STATE:
        USER_STATE[user_id] = init_state()
    return USER_STATE[user_id]


def get_words_for_theme(theme_id: str) -> List[int]:
    if theme_id == THEME_ALL or theme_id not in TOPICS:
        return list(range(len(WORDS)))
    return TOPICS[theme_id]["words"]


def reset_round(state: Dict[str, Any], keep_theme: bool = True, new_theme: str = None):
    if not keep_theme and new_theme is not None:
        state["theme"] = new_theme
    elif new_theme is not None:
        state["theme"] = new_theme

    candidates = get_words_for_theme(state["theme"])
    remaining = candidates.copy()
    random.shuffle(remaining)
    state["remaining"] = remaining
    state["correct"] = 0
    state["wrong"] = 0
    state["total"] = 0


def choose_mode_for_question(state_mode: str) -> str:
    if state_mode == MODE_MIXED:
        return random.choice([MODE_DE_RU, MODE_RU_DE])
    return state_mode


# ============================================================
# –ü–û–°–¢–†–û–ï–ù–ò–ï –í–ê–†–ò–ê–ù–¢–û–í –ò –ö–õ–ê–í–ò–ê–¢–£–†
# ============================================================

def build_options(question_index: int, mode: str) -> List[Dict[str, Any]]:
    correct = WORDS[question_index]
    indices_pool = list(range(len(WORDS)))
    indices_pool.remove(question_index)
    random.shuffle(indices_pool)
    wrong_indices = indices_pool[:3]

    options = []

    def make_text(w):
        if mode == MODE_DE_RU:
            return w["ru"]
        else:
            return f'{w["de"]} [{w["tr"]}]'

    options.append({"text": make_text(correct), "is_correct": True})

    for wi in wrong_indices:
        options.append({"text": make_text(WORDS[wi]), "is_correct": False})

    random.shuffle(options)
    return options


def build_keyboard_for_question(question_index: int, mode: str) -> InlineKeyboardMarkup:
    options = build_options(question_index, mode)
    rows = []
    row = []
    for opt in options:
        data = f"ans:{1 if opt['is_correct'] else 0}:{question_index}"
        row.append(InlineKeyboardButton(text=opt["text"], callback_data=data))
        if len(row) == 2:
            rows.append(row)
            row = []
    if row:
        rows.append(row)
    return InlineKeyboardMarkup(inline_keyboard=rows)


def build_themes_keyboard() -> InlineKeyboardMarkup:
    buttons = []
    buttons.append(
        [
            InlineKeyboardButton(
                text=f"–í—Å–µ —Ç–µ–º—ã ({len(WORDS)})",
                callback_data=f"theme:{THEME_ALL}",
            )
        ]
    )
    for topic_id, topic in sorted(TOPICS.items(), key=lambda x: x[1]["name"]):
        text = f'{topic["name"]} ({topic["count"]})'
        buttons.append(
            [InlineKeyboardButton(text=text, callback_data=f"theme:{topic_id}")]
        )

    return InlineKeyboardMarkup(inline_keyboard=buttons)


def build_mode_keyboard(current: str) -> InlineKeyboardMarkup:
    def label(m, txt):
        return f"‚úÖ {txt}" if m == current else txt

    buttons = [
        [
            InlineKeyboardButton(
                text=label(MODE_DE_RU, "üá©üá™ ‚Üí üá∑üá∫"),
                callback_data=f"mode:{MODE_DE_RU}",
            ),
            InlineKeyboardButton(
                text=label(MODE_RU_DE, "üá∑üá∫ ‚Üí üá©üá™"),
                callback_data=f"mode:{MODE_RU_DE}",
            ),
        ],
        [
            InlineKeyboardButton(
                text=label(MODE_MIXED, "üé≤ –°–º–µ—à–∞–Ω–Ω—ã–π"),
                callback_data=f"mode:{MODE_MIXED}",
            )
        ],
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)


# ============================================================
# –û–¢–ü–†–ê–í–ö–ê –í–û–ü–†–û–°–ê
# ============================================================

async def send_question(message: Message, user_id: int):
    state = get_user_state(user_id)

    # –µ—Å–ª–∏ —Ä–∞—É–Ω–¥ –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äì –∑–∞–ø—É—Å–∫–∞–µ–º
    if not state["remaining"]:
        reset_round(state)

    # –µ—Å–ª–∏ –ø–æ—Å–ª–µ reset_round –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ ‚Äì –≤ —Ç–µ–º–µ –Ω–µ—Ç —Å–ª–æ–≤
    if not state["remaining"]:
        await message.answer(
            "–í —ç—Ç–æ–π —Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —Ç–µ–º—É —á–µ—Ä–µ–∑ /themes."
        )
        return

    base_mode = state["mode"]
    mode = choose_mode_for_question(base_mode)

    # –±–µ—Ä—ë–º —Å–ª–æ–≤–æ, —É–¥–∞–ª—è—è –∏–∑ —Å–ø–∏—Å–∫–∞ remaining ‚Äì –Ω–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ
    q_index = state["remaining"].pop()
    word = WORDS[q_index]

    if mode == MODE_DE_RU:
        question_text = f'üá©üá™ {word["de"]} [{word["tr"]}] ‚Üí –≤—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º:'
    else:
        question_text = f'üá∑üá∫ {word["ru"]} ‚Üí –≤—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º:'

    kb = build_keyboard_for_question(q_index, mode)
    await message.answer(question_text, reply_markup=kb)


# ============================================================
# –•–ï–ù–î–õ–ï–†–´
# ============================================================

dp = Dispatcher()


@dp.message(CommandStart())
async def cmd_start(message: Message):
    user_id = message.from_user.id
    state = get_user_state(user_id)
    reset_round(state)  # –æ–±–Ω—É–ª—è–µ–º —Ä–∞—É–Ω–¥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

    total_words = len(WORDS)
    themes_count = len(TOPICS)

    text = (
        "üá©üá™ –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –Ω–µ–º–µ—Ü–∫–∏—Ö —Å–ª–æ–≤.\n\n"
        "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:\n"
        "‚Ä¢ –Ø –ø–æ–∫–∞–∑—ã–≤–∞—é —Å–ª–æ–≤–æ –∏ 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∞.\n"
        "‚Ä¢ –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–º.\n"
        "‚Ä¢ –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π, —è –ø–æ–∫–∞–∂—É –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ —Å—Ä–∞–∑—É –¥–∞–º –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ.\n"
        "‚Ä¢ –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –≤–µ—Ä–Ω—ã–π, –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –≥–∞–ª–æ—á–∫–æ–π, –∞ –Ω–∏–∂–µ –ø–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ.\n\n"
        f"–°–µ–π—á–∞—Å –≤ –±–∞–∑–µ: {total_words} —Å–ª–æ–≤.\n"
        f"–¢–µ–º: {themes_count}.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/next ‚Äì —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ\n"
        "/themes ‚Äì –≤—ã–±—Ä–∞—Ç—å —Ç–µ–º—É —Å–ª–æ–≤\n"
        "/mode ‚Äì –≤—ã–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞\n"
        "/stats ‚Äì —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º\n\n"
        "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º üá©üá™ ‚Üí üá∑üá∫.\n"
        "–ù–∞–∂–º–∏ /next, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫–≤–∏–∑."
    )

    await message.answer(text)


@dp.message(Command("next"))
async def cmd_next(message: Message):
    await send_question(message, message.from_user.id)


@dp.message(Command("themes"))
async def cmd_themes(message: Message):
    kb = build_themes_keyboard()
    await message.answer("–í—ã–±–µ—Ä–∏ —Ç–µ–º—É —Å–ª–æ–≤:", reply_markup=kb)


@dp.callback_query(F.data.startswith("theme:"))
async def callback_theme(call: CallbackQuery):
    await call.answer()
    theme_id = call.data.split(":", 1)[1]
    state = get_user_state(call.from_user.id)

    reset_round(state, keep_theme=False, new_theme=theme_id)

    if theme_id == THEME_ALL:
        text = (
            "–¢–µ–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞. –¢–µ–ø–µ—Ä—å —Å–ª–æ–≤–∞ –±–µ—Ä—É—Ç—Å—è –∏–∑ –≤—Å–µ—Ö —Ç–µ–º.\n"
            "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω—É–ª–µ–Ω–∞.\n"
            "–ù–∞–∂–º–∏ /next, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥."
        )
    else:
        topic = TOPICS.get(theme_id)
        if topic:
            text = (
                f'–¢–µ–º–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: "{topic["name"]}" ({topic["count"]} —Å–ª–æ–≤).\n'
                "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã –æ–±–Ω—É–ª–µ–Ω–∞.\n"
                "–ù–∞–∂–º–∏ /next, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥."
            )
        else:
            text = (
                "–≠—Ç–∞ —Ç–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É—é –≤—Å–µ —Å–ª–æ–≤–∞.\n"
                "–ù–∞–∂–º–∏ /next, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥."
            )
            state["theme"] = THEME_ALL

    await call.message.edit_reply_markup(reply_markup=None)
    await call.message.answer(text)


@dp.message(Command("mode"))
async def cmd_mode(message: Message):
    state = get_user_state(message.from_user.id)
    kb = build_mode_keyboard(state["mode"])
    await message.answer("–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –ø–µ—Ä–µ–≤–æ–¥–∞:", reply_markup=kb)


@dp.callback_query(F.data.startswith("mode:"))
async def callback_mode(call: CallbackQuery):
    await call.answer()
    mode_id = call.data.split(":", 1)[1]
    state = get_user_state(call.from_user.id)
    state["mode"] = mode_id

    # –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –æ–±–Ω—É–ª—è–µ–º —Ä–∞—É–Ω–¥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    reset_round(state)

    human = {
        MODE_DE_RU: "üá©üá™ ‚Üí üá∑üá∫ (–Ω–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ, –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º)",
        MODE_RU_DE: "üá∑üá∫ ‚Üí üá©üá™ (—Ä—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º)",
        MODE_MIXED: "üé≤ –°–º–µ—à–∞–Ω–Ω—ã–π (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–µ)",
    }.get(mode_id, "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º")

    await call.message.edit_reply_markup(reply_markup=None)
    await call.message.answer(
        f"–†–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {human}\n"
        "–¢–µ–∫—É—â–∏–π —Ä–∞—É–Ω–¥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω—É–ª–µ–Ω—ã.\n"
        "–ù–∞–∂–º–∏ /next, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ."
    )


@dp.message(Command("stats"))
async def cmd_stats(message: Message):
    total = len(WORDS)
    lines = [f"üìä –í —Å–ª–æ–≤–∞—Ä–µ —Å–µ–π—á–∞—Å: {total} —Å–ª–æ–≤."]

    if TOPICS:
        lines.append(f"–¢–µ–º: {len(TOPICS)}.")
        lines.append("")
        lines.append("–ü–æ —Ç–µ–º–∞–º:")
        for topic_id, topic in sorted(TOPICS.items(), key=lambda x: x[1]["name"]):
            lines.append(f'‚Ä¢ {topic["name"]}: {topic["count"]} —Å–ª–æ–≤')
    else:
        lines.append("–¢–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äì –≤—Å–µ —Å–ª–æ–≤–∞ –≤ –æ–¥–Ω–æ–π –æ–±—â–µ–π —Ç–µ–º–µ.")

    await message.answer("\n".join(lines))


@dp.callback_query(F.data.startswith("ans:"))
async def callback_answer(call: CallbackQuery):
    parts = call.data.split(":")
    is_correct = parts[1] == "1"
    word_index = int(parts[2])
    word = WORDS[word_index]

    state = get_user_state(call.from_user.id)

    if is_correct:
        state["correct"] += 1
        prefix = "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!"
        add_text = prefix
    else:
        state["wrong"] += 1
        correct_text = f'üá©üá™ {word["de"]} [{word["tr"]}] ‚Äì üá∑üá∫ {word["ru"]}'
        add_text = "‚ùå –ù–µ–≤–µ—Ä–Ω–æ.\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n" + correct_text

    state["total"] += 1

    await call.answer()
    await call.message.edit_reply_markup(reply_markup=None)
    await call.message.edit_text(call.message.text + "\n\n" + add_text)

    # –µ—Å–ª–∏ –µ—â—ë –µ—Å—Ç—å —Å–ª–æ–≤–∞ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ ‚Äì –∑–∞–¥–∞—ë–º —Å–ª–µ–¥—É—é—â–µ–µ
    if state["remaining"]:
        dummy_msg = call.message
        await send_question(dummy_msg, call.from_user.id)
    else:
        # —Ä–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äì –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        theme_id = state["theme"]
        if theme_id == THEME_ALL:
            theme_name = "–í—Å–µ —Ç–µ–º—ã"
        else:
            theme_name = TOPICS.get(theme_id, {}).get("name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–º–∞")

        total_q = state["total"]
        correct = state["correct"]
        wrong = state["wrong"]
        percent = int(round(correct * 100 / total_q)) if total_q > 0 else 0

        stats_text = (
            f'üìä –†–∞—É–Ω–¥ –ø–æ —Ç–µ–º–µ "{theme_name}" –∑–∞–≤–µ—Ä—à—ë–Ω.\n'
            f"–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {total_q}\n"
            f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {correct}\n"
            f"–û—à–∏–±–æ–∫: {wrong}\n"
            f"–¢–æ—á–Ω–æ—Å—Ç—å: {percent}%\n\n"
            "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ –ø–æ —ç—Ç–æ–π –∂–µ —Ç–µ–º–µ, –Ω–∞–∂–º–∏ /next.\n"
            "–ß—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —Ç–µ–º—É, –∏—Å–ø–æ–ª—å–∑—É–π /themes."
        )

        await call.message.answer(stats_text)
        # –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ –ø–æ–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ‚Äì –æ–Ω –Ω–∞—á–Ω—ë—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º /next


# ============================================================
# –ó–ê–ü–£–°–ö
# ============================================================

async def main():
    load_words()
    bot = Bot(TOKEN, parse_mode="HTML")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
