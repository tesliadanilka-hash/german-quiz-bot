import asyncio
import json
import random
from collections import defaultdict
from pathlib import Path
from typing import Dict, List, Any

from aiogram import Bot, Dispatcher, F
from aiogram.filters import CommandStart, Command
from aiogram.types import (
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)

# –í–°–¢–ê–í–¨ –°–í–û–ô –¢–û–ö–ï–ù –°–Æ–î–ê
TOKEN = "8583421204:AAHB_2Y8RjDQHDQLcqDLJkYfiP6oBqq3SyE"

bot = Bot(token=TOKEN)
dp = Dispatcher()

# –¢–∏–ø—ã
Word = Dict[str, Any]

# –ù–∞–∑–≤–∞–Ω–∏—è —Ç–µ–º –∫–∞–∫ –≤ —Ç–≤–æ–µ–º –º–µ–Ω—é
TOPIC_ALL = "–í—Å–µ —Ç–µ–º—ã (–ø–µ—Ä–µ–º–µ—à–∫—É)"
TOPIC_ABSTRACT = "–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è"
TOPIC_VERBS = "–ë–∞–∑–æ–≤—ã–µ –≥–ª–∞–≥–æ–ª—ã"
TOPIC_TIME = "–í—Ä–µ–º—è –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å"
TOPIC_CITY = "–ì–æ—Ä–æ–¥ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç"
TOPIC_HOME = "–î–æ–º –∏ –∂–∏–ª—å–µ"
TOPIC_FOOD = "–ï–¥–∞ –∏ –º–∞–≥–∞–∑–∏–Ω"
TOPIC_ANIMALS = "–ñ–∏–≤–æ—Ç–Ω—ã–µ"
TOPIC_TOOLS = "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –±—ã—Ç"
TOPIC_IT = "–ö–æ–º–ø—å—é—Ç–µ—Ä –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç"
TOPIC_PERSONAL = "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
TOPIC_CLOTHES = "–û–¥–µ–∂–¥–∞"
TOPIC_WEATHER = "–ü–æ–≥–æ–¥–∞ –∏ –ø—Ä–∏—Ä–æ–¥–∞"
TOPIC_OBJECTS = "–ü—Ä–µ–¥–º–µ—Ç—ã –∏ –≤–µ—â–∏"
TOPIC_GREETINGS = "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã"
TOPIC_JOBS = "–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞"
TOPIC_FAMILY = "–°–µ–º—å—è"
TOPIC_DICT = "–°–ª–æ–≤–∞—Ä—å A1-B1"
TOPIC_BODY = "–¢–µ–ª–æ –∏ –∑–¥–æ—Ä–æ–≤—å–µ"
TOPIC_HOBBY = "–•–æ–±–±–∏ –∏ —Å–ø–æ—Ä—Ç"
TOPIC_COLORS_NUM = "–¶–≤–µ—Ç–∞ –∏ —á–∏—Å–ª–∞"
TOPIC_SCHOOL = "–®–∫–æ–ª–∞ –∏ —É—á–µ–±–∞"
TOPIC_EMOTIONS = "–≠–º–æ—Ü–∏–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä"

ALL_TOPICS = [
    TOPIC_GREETINGS,
    TOPIC_ABSTRACT,
    TOPIC_VERBS,
    TOPIC_TIME,
    TOPIC_CITY,
    TOPIC_HOME,
    TOPIC_FOOD,
    TOPIC_ANIMALS,
    TOPIC_TOOLS,
    TOPIC_IT,
    TOPIC_PERSONAL,
    TOPIC_CLOTHES,
    TOPIC_WEATHER,
    TOPIC_OBJECTS,
    TOPIC_JOBS,
    TOPIC_FAMILY,
    TOPIC_BODY,
    TOPIC_HOBBY,
    TOPIC_COLORS_NUM,
    TOPIC_SCHOOL,
    TOPIC_EMOTIONS,
    TOPIC_DICT,
]

# –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞–º—è—Ç–∏
user_state: Dict[int, Dict[str, Any]] = defaultdict(
    lambda: {
        "mode": "de_ru",        # "de_ru" –∏–ª–∏ "ru_de"
        "topic": TOPIC_ALL,     # —Ç–µ–∫—É—â–∞—è —Ç–µ–º–∞
        "correct": 0,
        "wrong": 0,
        "remaining": None,      # —Å–ø–∏—Å–æ–∫ id –µ—â–µ –Ω–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º –∫—Ä—É–≥–µ
    }
)

WORDS: List[Word] = []
WORDS_BY_TOPIC: Dict[str, List[int]] = defaultdict(list)


def load_words(path: str = "words.json") -> None:
    """–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞ –∏–∑ JSON –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —Ç–µ–º—ã."""
    global WORDS, WORDS_BY_TOPIC

    file_path = Path(path)
    if not file_path.exists():
        raise FileNotFoundError(f"–§–∞–π–ª {path} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ª–æ–∂–∏ words.json —Ä—è–¥–æ–º —Å bot.py")

    with file_path.open("r", encoding="utf-8") as f:
        data = json.load(f)

    WORDS = []
    WORDS_BY_TOPIC = defaultdict(list)

    for idx, raw in enumerate(data):
        ru = raw["ru"].lower()
        topic = classify_topic(ru)

        word: Word = {
            "id": idx,
            "de": raw["de"],
            "tr": raw["tr"],
            "ru": raw["ru"],
            "topic": topic,
        }
        WORDS.append(word)
        WORDS_BY_TOPIC[topic].append(idx)
        WORDS_BY_TOPIC[TOPIC_DICT].append(idx)

    # –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ "–í—Å–µ —Ç–µ–º—ã"
    WORDS_BY_TOPIC[TOPIC_ALL] = list(range(len(WORDS)))


def classify_topic(ru: str) -> str:
    """–ì—Ä—É–±–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ä—É—Å—Å–∫–æ–º—É –ø–µ—Ä–µ–≤–æ–¥—É."""
    r = ru.lower()

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã
    greet_kw = [
        "–ø—Ä–∏–≤–µ—Ç", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
        "–¥–æ–±—Ä–æ–π –Ω–æ—á–∏", "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è", "–∫–∞–∫ –¥–µ–ª–∞", "—Å–ø–∞—Å–∏–±–æ",
        "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞", "–æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ", "–Ω–µ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ", "–∏–∑–≤–∏–Ω–∏—Ç–µ",
        "–º–Ω–µ –∂–∞–ª—å", "–æ–∫–µ–π", "–≤–µ—Ä–Ω–æ", "–ø—Ä–∞–≤–∏–ª—å–Ω–æ", "–¥–∞", "–Ω–µ—Ç",
    ]
    if any(k in r for k in greet_kw):
        return TOPIC_GREETINGS

    # –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    personal_kw = [
        "–∏–º—è", "—Ñ–∞–º–∏–ª–∏—è", "–∞–¥—Ä–µ—Å", "—É–ª–∏—Ü–∞", "–Ω–æ–º–µ—Ä –¥–æ–º–∞",
        "–ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å", "–º–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è", "–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
        "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å", "–ø–æ–¥–ø–∏—Å—å", "–≤–æ–∑—Ä–∞—Å—Ç", "–≥–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è",
        "–≥–æ–¥", "—Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ", "—è –µ—Å—Ç—å", "–º–µ–Ω—è –∑–æ–≤—É—Ç", "—è –∏–∑",
    ]
    if any(k in r for k in personal_kw):
        return TOPIC_PERSONAL

    # –°–µ–º—å—è
    family_kw = [
        "—Å–µ–º—å—è", "–º–∞—Ç—å", "–æ—Ç–µ—Ü", "—Å—ã–Ω", "–¥–æ—á—å", "–±–∞–±—É—à–∫–∞",
        "–¥–µ–¥", "–¥–µ–¥—É—à–∫–∞", "–≤–Ω—É–∫", "–≤–Ω—É—á–∫–∞", "–±—Ä–∞—Ç", "—Å–µ—Å—Ç—Ä–∞",
        "—Ç–µ—Ç—è", "–¥—è–¥—è", "–ø–æ–¥—Ä—É–≥–∞", "–¥—Ä—É–≥", "–∂–µ–Ω–∞—Ç", "–∑–∞–º—É–∂–µ–º",
        "—Ä–∞–∑–≤–µ–¥–µ–Ω", "–≤–¥–æ–≤–µ—Ü", "–æ–¥–∏–Ω–æ–∫–∏–π —Ä–æ–¥–∏—Ç–µ–ª—å",
    ]
    if any(k in r for k in family_kw):
        return TOPIC_FAMILY

    # –¢–µ–ª–æ –∏ –∑–¥–æ—Ä–æ–≤—å–µ
    body_kw = [
        "–≥–æ–ª–æ–≤–∞", "–ª–∏—Ü–æ", "–≥–ª–∞–∑", "–±—Ä–æ–≤—å", "–Ω–æ—Å", "—Ä–æ—Ç", "–∑—É–±",
        "–∑—É–±—ã", "—É—Ö–æ", "–≤–æ–ª–æ—Å", "–≤–æ–ª–æ—Å—ã", "—à–µ—è", "–ø–ª–µ—á–æ", "—Ä—É–∫–∞",
        "–∫–∏—Å—Ç—å", "–ø–∞–ª–µ—Ü", "–≥—Ä—É–¥—å", "—Å–ø–∏–Ω–∞", "–∂–∏–≤–æ—Ç", "–Ω–æ–≥–∞",
        "—Å—Ç–æ–ø–∞", "–∫–æ–ª–µ–Ω–æ", "–∫–æ—Å—Ç—å", "–∫—Ä–æ–≤—å", "–ø–µ—á–µ–Ω—å", "–ª–µ–≥–∫–æ–µ",
        "–º—ã—à—Ü–∞", "–∑–¥–æ—Ä–æ–≤—å–µ", "–∑–¥–æ—Ä–æ–≤—ã–π", "–±–æ–ª—å–Ω–æ–π", "—É—Å—Ç–∞–ª—ã–π",
        "—É—Å—Ç–∞–≤—à–∏–π", "–±–æ–ª—å–Ω–∏—Ü–∞", "–ø—Ä–æ—Å—Ç—É–¥–∞", "–≥—Ä–∏–ø–ø", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞",
        "—Ç–∞–±–ª–µ—Ç–∫–∞", "–ª–µ–∫–∞—Ä—Å—Ç–≤–æ", "–º–∞–∑—å", "–ø–æ–≤—è–∑–∫–∞",
    ]
    if any(k in r for k in body_kw):
        return TOPIC_BODY

    # –≠–º–æ—Ü–∏–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä
    emo_kw = [
        "—Å—á–∞—Å—Ç–ª–∏–≤—ã–π", "–≥—Ä—É—Å—Ç–Ω—ã–π", "–∑–ª–æ–π", "—Å–ø–æ–∫–æ–π–Ω—ã–π", "–Ω–µ—Ä–≤–Ω—ã–π",
        "—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π", "–≥–æ—Ä–¥—ã–π", "–∑–∞—Å—Ç–µ–Ω—á–∏–≤—ã–π", "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π",
        "–≥–æ—Ç–æ–≤—ã–π –ø–æ–º–æ—á—å", "–≤–µ–∂–ª–∏–≤—ã–π", "–Ω–µ–≤–µ–∂–ª–∏–≤—ã–π", "—Å—Ç—Ä–∞–Ω–Ω—ã–π",
        "—Å–º–µ—à–Ω–æ–π", "—Å–µ—Ä—å–µ–∑–Ω—ã–π", "—Å–∫—É—á–Ω—ã–π", "–∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π",
        "–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π", "–≤–∞–∂–Ω—ã–π", "—á–µ—Å—Ç–Ω—ã–π", "–ª–µ–Ω–∏–≤—ã–π", "—Ç—Ä—É–¥–æ–ª—é–±–∏–≤—ã–π",
        "—Å–º–µ–ª—ã–π", "—Ç—Ä—É—Å–ª–∏–≤—ã–π", "—É–º–Ω—ã–π", "–≥–ª—É–ø—ã–π", "–Ω–∞–≥–ª—ã–π",
        "—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π", "–Ω–µ—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π", "—Å–∏–º–ø–∞—Ç–∏—á–Ω—ã–π", "–Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π",
        "—Å —á—É–≤—Å—Ç–≤–æ–º —é–º–æ—Ä–∞", "—É—Å–ø–µ—à–Ω—ã–π", "–ª—é–±–æ–ø—ã—Ç–Ω—ã–π", "–º–µ–¥–ª–µ–Ω–Ω—ã–π",
        "–±—ã—Å—Ç—Ä—ã–π", "—Å–∏–ª—å–Ω—ã–π", "–∑–ª–æ—Å—Ç—å", "—Ä–∞–¥–æ—Å—Ç—å", "—Å—Ç—Ä–∞—Ö",
        "—Å–º–µ–ª–æ—Å—Ç—å", "—Å—é—Ä–ø—Ä–∏–∑", "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ", "—É–≤–∞–∂–µ–Ω–∏–µ",
        "—Å–æ–º–Ω–µ–Ω–∏–µ", "–Ω–∞–¥–µ–∂–¥–∞", "—Ç–µ—Ä–ø–µ–Ω–∏–µ",
    ]
    if any(k in r for k in emo_kw):
        return TOPIC_EMOTIONS

    # –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞
    jobs_kw = [
        "–≤—Ä–∞—á", "—É—á–∏—Ç–µ–ª—å", "–∏–Ω–∂–µ–Ω–µ—Ä", "–ø–æ–≤–∞—Ä", "–º–µ–¥–±—Ä–∞—Ç", "–º–µ–¥—Å–µ—Å—Ç—Ä–∞",
        "—Ç–∞–∫—Å–∏—Å—Ç", "–ø—Ä–æ–¥–∞–≤–µ—Ü", "–ø—Ä–æ–¥–∞–≤—â–∏—Ü–∞", "–ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä", "–ø–µ–≤–µ—Ü",
        "–ø–µ–≤–∏—Ü–∞", "–æ—Ñ–∏—Ü–∏–∞–Ω—Ç", "–∞–∫—Ç—Ä–∏—Å–∞", "–∞–∫—Ç–µ—Ä", "—ç–ª–µ–∫—Ç—Ä–æ–Ω—â–∏–∫",
        "–¥–æ–º–æ—Ö–æ–∑—è–∏–Ω", "–¥–æ–º–æ—Ö–æ–∑—è–π–∫–∞", "–ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π", "—Å—Ç—É–¥–µ–Ω—Ç",
        "—Å—Ç—É–¥–µ–Ω—Ç–∫–∞", "—Ä–∞–±–æ—Ç–∞", "–ø—Ä–æ—Ñ–µ—Å—Å–∏—è", "–Ω–∞—á–∞–ª—å–Ω–∏–∫",
        "–Ω–∞—á–∞–ª—å–Ω–∏—Ü–∞", "–æ—Ñ–∏—Å", "—Ñ–∏—Ä–º–∞", "–∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É",
        "—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ", "—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è", "–ø–µ—Ä–µ—Ä—ã–≤",
        "–∑–∞—Ä–ø–ª–∞—Ç–∞", "–æ–∫–ª–∞–¥", "–ø–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å",
        "–Ω–µ–ø–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å", "–∫–æ–º–∞–Ω–¥–∞", "—Å–æ–≤–µ—â–∞–Ω–∏–µ",
        "—à–µ—Ñ –ø–æ–≤–∞—Ä", "–≤–ª–∞–¥–µ–ª–µ—Ü", "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫", "–∫–æ–Ω—Ç—Ä–∞–∫—Ç",
        "–æ–ø—Ç–∏–∫", "–ø–µ–∫–∞—Ä—å", "–º—è—Å–Ω–∏–∫", "–º–µ—Ö–∞–Ω–∏–∫", "—ç–ª–µ–∫—Ç—Ä–∏–∫",
        "–º–∞–ª—è—Ä", "–ø–æ—Ä—Ç–Ω–æ–π", "—Ö–∏–º—á–∏—Å—Ç–∫–∞", "—Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã",
    ]
    if any(k in r for k in jobs_kw):
        return TOPIC_JOBS

    # –®–∫–æ–ª–∞ –∏ —É—á–µ–±–∞
    school_kw = [
        "—à–∫–æ–ª–∞", "—à–∫–æ–ª—å–Ω–∏–∫", "—à–∫–æ–ª—å–Ω–∏—Ü–∞", "–∫–ª–∞—Å—Å", "—É—Ä–æ–∫",
        "–¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ", "—ç–∫–∑–∞–º–µ–Ω", "—Ç–µ—Å—Ç", "–ø–æ–≤—Ç–æ—Ä—è—Ç—å",
        "–æ–±—ä—è—Å–Ω—è—Ç—å", "–ø–æ–Ω–∏–º–∞—Ç—å", "–∫—É—Ä—Å", "—É—á–∏—Ç—å—Å—è", "–∑–∞–Ω—è—Ç–∏–µ",
        "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
    ]
    if any(k in r for k in school_kw):
        return TOPIC_SCHOOL

    # –•–æ–±–±–∏ –∏ —Å–ø–æ—Ä—Ç
    hobby_kw = [
        "—Å–ø–æ—Ä—Ç", "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", "–∏–≥—Ä–∞—Ç—å", "–∏–≥—Ä–æ–∫", "–≤–µ–ª–æ—Å–∏–ø–µ–¥",
        "–∫–æ–º–∞–Ω–¥–∞", "–º—É–∑—ã–∫–∞", "—Å–ª—É—à–∞—Ç—å", "—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å", "–ø–µ—á—å",
        "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å", "–ø–∏–∞–Ω–∏–Ω–æ", "—Ä–∏—Å–æ–≤–∞—Ç—å", "—à–∏—Ç—å", "–ø–ª–∞–≤–∞—Ç—å",
        "–ø–µ—Ç—å", "–≥–∏—Ç–∞—Ä–∞", "–≤–∏–¥–µ–æ", "—Ö–æ–±–±–∏", "—Ñ–∏–ª—å–º", "—Å–µ—Ä–∏—è", "—Å–µ—Ä–∏–∞–ª",
    ]
    if any(k in r for k in hobby_kw):
        return TOPIC_HOBBY

    # –¶–≤–µ—Ç–∞ –∏ —á–∏—Å–ª–∞
    color_kw = [
        "–∫—Ä–∞—Å–Ω—ã–π", "—Å–∏–Ω–∏–π", "–∑–µ–ª–µ–Ω—ã–π", "–∂–µ–ª—Ç—ã–π", "—á–µ—Ä–Ω—ã–π", "–±–µ–ª—ã–π",
        "—Å–µ—Ä—ã–π", "–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π", "–æ—Ä–∞–Ω–∂–µ–≤—ã–π", "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π", "—Ä–æ–∑–æ–≤—ã–π",
        "–Ω–æ–ª—å", "–æ–¥–∏–Ω", "–¥–≤–∞", "—Ç—Ä–∏", "—á–µ—Ç—ã—Ä–µ", "–ø—è—Ç—å", "—à–µ—Å—Ç—å",
        "—Å–µ–º—å", "–≤–æ—Å–µ–º—å", "–¥–µ–≤—è—Ç—å", "–¥–µ—Å—è—Ç—å", "–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å",
        "–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å", "–¥–≤–∞–¥—Ü–∞—Ç—å", "—Ç—Ä–∏–¥—Ü–∞—Ç—å", "—Å–æ—Ä–æ–∫", "–ø—è—Ç—å–¥–µ—Å—è—Ç",
        "—à–µ—Å—Ç–¥–µ—Å—è—Ç", "—Å–µ–º—å–¥–µ—Å—è—Ç", "–≤–æ—Å–µ–º—å–¥–µ—Å—è—Ç", "–¥–µ–≤—è–Ω–æ—Å—Ç–æ", "—Å—Ç–æ",
    ]
    if any(k in r for k in color_kw):
        return TOPIC_COLORS_NUM

    # –û–¥–µ–∂–¥–∞
    clothes_kw = [
        "—Ä—É–±–∞—à–∫–∞", "—à—Ç–∞–Ω—ã", "–¥–∂–∏–Ω—Å—ã", "—Ñ—É—Ç–±–æ–ª–∫–∞", "—Å–≤–∏—Ç–µ—Ä",
        "–∫—É—Ä—Ç–∫–∞", "–ø–∞–ª—å—Ç–æ", "–±–ª—É–∑–∫–∞", "—é–±–∫–∞", "–ø–ª–∞—Ç—å–µ", "–æ–±—É–≤—å",
        "–±–æ—Ç–∏–Ω–æ–∫", "–Ω–æ—Å–∫–∏", "—Å–∞–ø–æ–≥–∏", "—Ä–µ–º–µ–Ω—å", "—à–ª—è–ø–∞", "—à–∞–ø–∫–∞",
        "—à–∞—Ä—Ñ", "–ø–µ—Ä—á–∞—Ç–∫–∏", "—Ç—Ä—É—Å—ã", "–ª–∏—Ñ—á–∏–∫", "–∫–æ—Å—Ç—é–º", "–æ–¥–µ–∂–¥–∞",
        "–º–æ–¥–∞", "—Ç–∫–∞–Ω—å", "–ø—É–≥–æ–≤–∏—Ü–∞", "–∫–Ω–æ–ø–∫–∞", "–º–æ–ª–Ω–∏—è", "—Ä–∞–∑–º–µ—Ä",
    ]
    if any(k in r for k in clothes_kw):
        return TOPIC_CLOTHES

    # –ñ–∏–≤–æ—Ç–Ω—ã–µ
    animals_kw = [
        "—Å–æ–±–∞–∫–∞", "–∫–æ—à–∫–∞", "–ø—Ç–∏—Ü–∞", "–ª–æ—à–∞–¥—å", "–∫–æ—Ä–æ–≤–∞", "—Å–≤–∏–Ω—å—è",
        "–æ–≤—Ü–∞", "–º—ã—à—å", "–º–µ–¥–≤–µ–¥—å", "–ª–µ–≤", "–∑–º–µ—è", "—Ç–∏–≥—Ä", "–∑–∞—è—Ü",
        "–æ–±–µ–∑—å—è–Ω–∞", "–≤–µ—Ä–±–ª—é–¥", "–≤–æ–ª–∫", "–ª–∏—Å–∞", "–ø–µ—Ç—É—Ö", "—É—Ç–∫–∞", "—Ä—ã–±–∞",
    ]
    if any(k in r for k in animals_kw):
        return TOPIC_ANIMALS

    # –î–æ–º –∏ –∂–∏–ª—å–µ
    home_kw = [
        "–¥–æ–º", "–∫–≤–∞—Ä—Ç–∏—Ä–∞", "–∫–æ–º–Ω–∞—Ç–∞", "–≥–æ—Å—Ç–∏–Ω–∞—è", "—Å–ø–∞–ª—å–Ω—è",
        "–∫—É—Ö–Ω—è", "–≤–∞–Ω–Ω–∞—è", "—Ç—É–∞–ª–µ—Ç", "–∫–æ—Ä–∏–¥–æ—Ä", "–±–∞–ª–∫–æ–Ω", "—Å–∞–¥",
        "–æ–∫–Ω–æ", "–¥–≤–µ—Ä—å", "—Å—Ç–æ–ª", "—Å—Ç—É–ª", "–∫—Ä–æ–≤–∞—Ç—å", "—à–∫–∞—Ñ", "–ª–∞–º–ø–∞",
        "–∫–æ–≤–µ—Ä", "–¥–∏–≤–∞–Ω", "–∑–µ—Ä–∫–∞–ª–æ", "—à—Ç–æ—Ä–∞", "—Å—Ç–µ–Ω–∞", "–ø–æ–ª",
        "–ø–æ—Ç–æ–ª–æ–∫", "–¥—É—à", "–≤–∞–Ω–Ω–∞", "–≤—Ö–æ–¥",
    ]
    if any(k in r for k in home_kw):
        return TOPIC_HOME

    # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –±—ã—Ç
    tools_kw = [
        "–ø—ã–ª–µ—Å–æ—Å", "–º–µ—Ç–ª–∞", "–≤–µ–¥—Ä–æ", "–≥—É–±–∫–∞", "—Ç—Ä—è–ø–∫–∞", "—Ä–æ–∑–µ—Ç–∫–∞",
        "–ª–∞–º–ø–æ—á–∫–∞", "–º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞", "—á–∞–π–Ω–∏–∫ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π",
        "–º—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç", "–º—É—Å–æ—Ä–Ω—ã–π –±–∞–∫", "–º—É—Å–æ—Ä", "–º–æ–ª–æ—Ç–æ–∫", "–≥–≤–æ–∑–¥—å",
        "–≤–∏–Ω—Ç", "–æ—Ç–≤–µ—Ä—Ç–∫–∞", "–¥—Ä–µ–ª—å", "–ø–∏–ª–∞", "–ø–ª–æ—Å–∫–æ–≥—É–±—Ü—ã", "—à–ª–∞–Ω–≥",
        "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "—Å–∫–æ–≤–æ—Ä–æ–¥–∞", "–∫–∞—Å—Ç—Ä—é–ª—è", "–ø–ª–∏—Ç–∞", "–¥—É—Ö–æ–≤–∫–∞",
    ]
    if any(k in r for k in tools_kw):
        return TOPIC_TOOLS

    # –ö–æ–º–ø—å—é—Ç–µ—Ä –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
    it_kw = [
        "–∫–æ–º–ø—å—é—Ç–µ—Ä", "–Ω–æ—É—Ç–±—É–∫", "–º—ã—à—å", "–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞", "—ç–∫—Ä–∞–Ω",
        "–º–æ–Ω–∏—Ç–æ—Ä", "—Ñ–∞–π–ª", "–ø–∞–ø–∫–∞", "—Å–æ—Ö—Ä–∞–Ω—è—Ç—å", "—É–¥–∞–ª—è—Ç—å",
        "–ø–∞—Ä–æ–ª—å", "–≤—Ö–æ–¥–∏—Ç—å", "–≤—ã—Ö–æ–¥–∏—Ç—å", "–ø—Ä–æ–≥—Ä–∞–º–º–∞", "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        "—Å–∫–∞—á–∏–≤–∞—Ç—å", "–∑–∞–≥—Ä—É–∂–∞—Ç—å", "–ø—Ä–∏–Ω—Ç–µ—Ä", "–ø–µ—á–∞—Ç–∞—Ç—å", "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
        "–≤–∞–π-—Ñ–∞–π",
    ]
    if any(k in r for k in it_kw):
        return TOPIC_IT

    # –ì–æ—Ä–æ–¥ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
    city_kw = [
        "–≥–æ—Ä–æ–¥", "–¥–µ—Ä–µ–≤–Ω—è", "—É–ª–∏—Ü–∞", "–ø–ª–æ—â–∞–¥—å", "–ø–∞—Ä–∫", "–º–æ—Å—Ç",
        "–≤–æ–∫–∑–∞–ª", "–∞—ç—Ä–æ–ø–æ—Ä—Ç", "–æ—Å—Ç–∞–Ω–æ–≤–∫–∞", "–º–µ—Ç—Ä–æ",
        "–≥–æ—Ä–æ–¥—Å–∫–∞—è —ç–ª–µ–∫—Ç—Ä–∏—á–∫–∞", "–ø–æ–µ–∑–¥", "–∞–≤—Ç–æ–±—É—Å", "—Ç–∞–∫—Å–∏",
        "–ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫", "—Å–≤–µ—Ç–æ—Ñ–æ—Ä", "–∞–ø—Ç–µ–∫–∞", "–ø–µ–∫–∞—Ä–Ω—è", "–±–∞–Ω–∫",
        "–ø–æ—á—Ç–∞", "–ø–æ–ª–∏—Ü–∏—è", "–¥–µ—Ç—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞", "–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä",
        "—Ç–µ–∞—Ç—Ä", "–º—É–∑–µ–π", "–ø–æ—Ä—Ç", "–ø–∞—Ä–∫–æ–≤–∫–∞", "—Ä—ã–Ω–æ–∫",
        "–æ–∫—Ä–µ—Å—Ç–Ω–æ—Å—Ç—å", "—Ä–∞–π–æ–Ω", "—Ç—É–Ω–Ω–µ–ª—å", "–ø–ª—è–∂",
    ]
    if any(k in r for k in city_kw):
        return TOPIC_CITY

    # –ü–æ–≥–æ–¥–∞ –∏ –ø—Ä–∏—Ä–æ–¥–∞
    weather_kw = [
        "–ø–æ–≥–æ–¥–∞", "–≤–µ—Å–Ω–∞", "–ª–µ—Ç–æ", "–æ—Å–µ–Ω—å", "–∑–∏–º–∞", "—Ç–µ–ø–ª–æ", "—Ö–æ–ª–æ–¥–Ω–æ",
        "–ø–∞—Å–º—É—Ä–Ω–æ", "–∏–¥–µ—Ç –¥–æ–∂–¥—å", "–∏–¥–µ—Ç —Å–Ω–µ–≥", "—Å–≤–µ—Ç–∏—Ç —Å–æ–ª–Ω—Ü–µ",
        "–≥—Ä–∞–¥—É—Å", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "—Å–Ω–µ–≥", "–¥–æ–∂–¥—å", "–≤–µ—Ç–µ—Ä",
        "—Ç—É–º–∞–Ω", "–Ω–µ–±–æ", "–æ–±–ª–∞–∫–æ", "—Ä–∞–¥—É–≥–∞", "—à—Ç–æ—Ä–º", "–ª–µ—Å", "—Ä–µ–∫–∞",
        "—Ä—É—á–µ–π", "—Ö–æ–ª–º", "–ª—É–≥", "–ø–æ–ª–µ", "—Å–∫–∞–ª–∞", "–æ—Å—Ç—Ä–æ–≤", "–º–æ—Ä–µ",
        "–æ–∑–µ—Ä–æ", "–ø—Ä–∏—Ä–æ–¥–∞", "–∑–µ–º–ª—è", "–∫–ª–∏–º–∞—Ç",
    ]
    if any(k in r for k in weather_kw):
        return TOPIC_WEATHER

    # –ï–¥–∞ –∏ –º–∞–≥–∞–∑–∏–Ω
    food_kw = [
        "–∫–æ—Ñ–µ", "—á–∞–π", "–º–æ–ª–æ–∫–æ", "–≤–æ–¥–∞", "—Å–æ–∫", "–ø–∏–≤–æ", "—Ö–ª–µ–±",
        "–±—É–ª–æ—á–∫–∞", "–∫—Ä—É–∞—Å—Å–∞–Ω", "—è–π—Ü–æ", "—è–±–ª–æ–∫–æ", "–≥—Ä—É—à–∞", "—Ñ—Ä—É–∫—Ç—ã",
        "–º—é—Å–ª–∏", "–π–æ–≥—É—Ä—Ç", "—Ç–æ—Ä—Ç", "–∫–æ–ª–±–∞—Å–∞", "—Å—ã—Ä", "–∫–∞—Ä—Ç–æ—à–∫–∞",
        "–≤–µ—Ç—á–∏–Ω–∞", "—Å–∞–ª–∞—Ç", "–ø–æ–º–∏–¥–æ—Ä", "—Å–ª–∏–≤–∫–∏", "–±–∞–Ω–∞–Ω", "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç",
        "–ø—Ä–æ–¥—É–∫—Ç –ø–∏—Ç–∞–Ω–∏—è", "—Å–≤–µ–∂–∏–π", "–≤–∫—É—Å–Ω—ã–π", "–æ–≤–æ—â–∏", "–º—è—Å–æ",
        "–Ω–∞–ø–∏—Ç–æ–∫", "–¥–µ—Å–µ—Ä—Ç", "–µ–¥–∞", "–ª—é–±–∏–º–∞—è –µ–¥–∞", "—Ä–∏—Å", "—à–æ–∫–æ–ª–∞–¥",
        "–º–æ—Ä–æ–∂–µ–Ω–æ–µ", "—Å—É–ø", "—É–∂–∏–Ω", "–æ–±–µ–¥", "–º–∞—Å–ª–æ", "—Ä—ã–±–∞", "—Å—á–µ—Ç",
        "–±—Ä–∞—Ç—å", "–ø–æ–∫—É–ø–∞—Ç—å", "–∑–∞–∫—É–ø–∞—Ç—å—Å—è", "–µ–≤—Ä–æ", "—Ü–µ–Ω—Ç", "–∫–ª–∏–µ–Ω—Ç",
        "–∫–ª–∏–µ–Ω—Ç–∫–∞", "–ø–∞–∫–µ—Ç", "–ø–æ–∫—É–ø–∫–∞", "–±–∞–Ω–∫–∞", "–±—É—Ç—ã–ª–∫–∞", "—Å—Ç–∞–∫–∞–Ω—á–∏–∫",
        "–≥—Ä–∞–º–º", "–∫–∏–ª–æ–≥—Ä–∞–º–º", "–ª–∏—Ç—Ä", "–ø—Ä–æ–¥—É–∫—Ç", "–¥–æ—Å—Ç–∞–≤–∫–∞", "–∑–∞–∫–∞–∑",
        "—Å–∫–∏–¥–∫–∞", "—Å–µ—Ä–≤–∏—Å",
    ]
    if any(k in r for k in food_kw):
        return TOPIC_FOOD

    # –í—Ä–µ–º—è –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    time_kw = [
        "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞", "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞",
        "—Å—É–±–±–æ—Ç–∞", "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", "—É—Ç—Ä–æ", "–≤–µ—á–µ—Ä", "–Ω–æ—á—å",
        "–ø–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è", "–≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è", "–ø–æ–ª–¥–µ–Ω—å",
        "–Ω–µ–¥–µ–ª—è", "–º–µ—Å—è—Ü", "–º–∞—Ä—Ç", "–∞–ø—Ä–µ–ª—å", "–º–∞–π", "–∏—é–Ω—å", "–∏—é–ª—å",
        "–∞–≤–≥—É—Å—Ç", "—Å–µ–Ω—Ç—è–±—Ä—å", "–æ–∫—Ç—è–±—Ä—å", "–Ω–æ—è–±—Ä—å", "–¥–µ–∫–∞–±—Ä—å",
        "–≤—Ä–µ–º—è", "–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å", "—Å–µ–≥–æ–¥–Ω—è", "–∑–∞–≤—Ç—Ä–∞", "—á–∞—Å",
    ]
    if any(k in r for k in time_kw):
        return TOPIC_TIME

    # –ü—Ä–µ–¥–º–µ—Ç—ã –∏ –≤–µ—â–∏
    objects_kw = [
        "–∫–Ω–∏–≥–∞", "—Ç–µ—Ç—Ä–∞–¥—å", "–±—É–º–∞–≥–∞", "–∫–∞—Ä–∞–Ω–¥–∞—à", "—Ä—É—á–∫–∞", "–ª–∏–Ω–µ–π–∫–∞",
        "–∫–∞–º–µ—Ä–∞", "–ø—Ä–∏–Ω—Ç–µ—Ä", "—Ç–µ–ª–µ—Ñ–æ–Ω", "—Å—É–º–∫–∞", "—Ä—é–∫–∑–∞–∫", "–∫–æ—à–µ–ª–µ–∫",
        "–∫–ª—é—á", "–∫–ª–µ–π", "–Ω–æ–∂–Ω–∏—Ü—ã", "–∑–æ–Ω—Ç", "–æ—á–∫–∏", "–∑–∞–∂–∏–≥–∞–ª–∫–∞",
        "–≥–∞–∑–µ—Ç–∞", "—á–∞—à–∫–∞", "—á–µ–º–æ–¥–∞–Ω", "–ø–æ—á—Ç–æ–≤–∞—è –º–∞—Ä–∫–∞", "—Å–ª–æ–≤–æ",
        "–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ", "—Ç–µ–∫—Å—Ç", "–æ—à–∏–±–∫–∞", "–≤–æ–ø—Ä–æ—Å", "–æ—Ç–≤–µ—Ç", "–ø–æ—á—Ç–∞",
        "–±–∞–ª–∫–æ–Ω", "–≤—Ö–æ–¥",
    ]
    if any(k in r for k in objects_kw):
        return TOPIC_OBJECTS

    # –ë–∞–∑–æ–≤—ã–µ –≥–ª–∞–≥–æ–ª—ã
    first_word = r.split()[0]
    if first_word.endswith("—Ç—å") or first_word.endswith("—Ç—å—Å—è"):
        return TOPIC_VERBS

    # –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è
    abstract_kw = [
        "–∏–¥–µ—è", "–º–µ—á—Ç–∞", "–∂–µ–ª–∞–Ω–∏–µ", "–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å", "–ø—Ä–æ–±–ª–µ–º–∞",
        "—Ä–µ—à–µ–Ω–∏–µ", "–±—É–¥—É—â–µ–µ", "–ø—Ä–æ—à–ª–æ–µ", "–Ω–∞—Å—Ç–æ—è—â–µ–µ", "—Å—Ç—Ä–∞–Ω–∏—Ü–∞",
        "—Å—Ç–æ—Ä–æ–Ω–∞", "–Ω–∞—á–∞–ª–æ", "–∫–æ–Ω–µ—Ü", "—Å–µ—Ä–µ–¥–∏–Ω–∞", "–ø—Ä–∏—á–∏–Ω–∞", "–æ–ø—ã—Ç",
        "–ø–æ–º–æ—â—å", "—Ü–µ–ª—å",
    ]
    if any(k in r for k in abstract_kw):
        return TOPIC_ABSTRACT

    return TOPIC_DICT


def get_user_words(uid: int) -> List[int]:
    state = user_state[uid]
    topic = state["topic"]
    if topic not in WORDS_BY_TOPIC or topic == TOPIC_ALL:
        return WORDS_BY_TOPIC[TOPIC_ALL]
    return WORDS_BY_TOPIC[topic]


def reset_progress(uid: int) -> None:
    """–°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –Ω–æ–≤—ã–π –∫—Ä—É–≥ —Å–ª–æ–≤ –ø–æ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ."""
    state = user_state[uid]
    state["correct"] = 0
    state["wrong"] = 0
    ids = get_user_words(uid)
    ids = ids.copy()
    random.shuffle(ids)
    state["remaining"] = ids


def build_options(word_ids: List[int], correct_id: int, mode: str) -> InlineKeyboardMarkup:
    """–°—Ç—Ä–æ–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞."""
    pool = set(word_ids)
    pool.discard(correct_id)
    wrong_ids = random.sample(list(pool), k=3) if len(pool) >= 3 else list(pool)

    all_ids = wrong_ids + [correct_id]
    random.shuffle(all_ids)

    buttons = []
    for wid in all_ids:
        w = WORDS[wid]
        if mode == "de_ru":
            text = w["ru"]
        else:
            text = f'{w["de"]} [{w["tr"]}]'
        # –≤ callback –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ id –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–ª–æ–≤–∞ –∏ —Ä–µ–∂–∏–º
        cb_data = f"ans|{correct_id}|{mode}|{1 if wid == correct_id else 0}"
        buttons.append([InlineKeyboardButton(text=text, callback_data=cb_data)])

    return InlineKeyboardMarkup(inline_keyboard=buttons)


async def send_new_word(user_id: int, chat_id: int) -> None:
    state = user_state[user_id]
    # –µ—Å–ª–∏ remaining –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ /start)
    if state["remaining"] is None:
        reset_progress(user_id)

    if not state["remaining"]:
        await bot.send_message(
            chat_id,
            "–¢—ã —É–∂–µ –ø—Ä–æ—à–µ–ª –≤—Å–µ —Å–ª–æ–≤–∞ –≤ —ç—Ç–æ–π —Ç–µ–º–µ.\n"
            "–ù–∞–ø–∏—à–∏ /next —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –∫—Ä—É–≥ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥—É—é —Ç–µ–º—É —á–µ—Ä–µ–∑ /themes.",
        )
        return

    # –±–µ—Ä–µ–º –æ–¥–Ω–æ —Å–ª–æ–≤–æ –∏–∑ remaining –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤
    word_id = state["remaining"].pop()
    w = WORDS[word_id]
    mode = state["mode"]
    word_pool = get_user_words(user_id)

    if mode == "de_ru":
        text = f'üá©üá™ –°–ª–æ–≤–æ: {w["de"]} [{w["tr"]}]\n–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π.'
    else:
        text = f'üá∑üá∫ –°–ª–æ–≤–æ: {w["ru"]}\n–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –Ω–µ–º–µ—Ü–∫–∏–π.'

    kb = build_options(word_pool, word_id, mode)
    await bot.send_message(chat_id, text, reply_markup=kb)


def build_themes_keyboard() -> InlineKeyboardMarkup:
    rows = []
    for topic in ALL_TOPICS:
        count = len(WORDS_BY_TOPIC.get(topic, []))
        text = f"{topic} ({count})"
        cb = f"topic|{topic}"
        rows.append([InlineKeyboardButton(text=text, callback_data=cb)])

    rows.insert(
        0,
        [InlineKeyboardButton(
            text=f"{TOPIC_ALL} ({len(WORDS)})",
            callback_data=f"topic|{TOPIC_ALL}",
        )],
    )
    return InlineKeyboardMarkup(inline_keyboard=rows)


def build_mode_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üá©üá™ ‚Üí üá∑üá∫ –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ",
                    callback_data="mode|de_ru",
                )
            ],
            [
                InlineKeyboardButton(
                    text="üá∑üá∫ ‚Üí üá©üá™ –†—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ",
                    callback_data="mode|ru_de",
                )
            ],
        ]
    )


@dp.message(CommandStart())
async def cmd_start(message: Message) -> None:
    uid = message.from_user.id

    total_words = len(WORDS)
    used_topics = {w["topic"] for w in WORDS}
    total_topics = len(used_topics)

    text = (
        "üá©üá™ –ü—Ä–∏–≤–µ—Ç. –≠—Ç–æ –±–æ—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –Ω–µ–º–µ—Ü–∫–∏—Ö —Å–ª–æ–≤.\n\n"
        "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:\n"
        "‚Ä¢ –Ø –ø–æ–∫–∞–∑—ã–≤–∞—é —Å–ª–æ–≤–æ –∏ 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∞.\n"
        "‚Ä¢ –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–º.\n"
        "‚Ä¢ –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π, —è –ø–æ–∫–∞–∂—É –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ —Å—Ä–∞–∑—É –¥–∞–º –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ.\n"
        "‚Ä¢ –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –≤–µ—Ä–Ω—ã–π, –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –≥–∞–ª–æ—á–∫–æ–π, –∞ –Ω–∏–∂–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ.\n\n"
        f"–°–µ–π—á–∞—Å –≤ –±–∞–∑–µ {total_words} —Å–ª–æ–≤.\n"
        f"–¢–µ–º: {total_topics}.\n\n"
        "–†–µ–∂–∏–º—ã:\n"
        "‚Ä¢ üá©üá™ ‚Üí üá∑üá∫ –Ω–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º.\n"
        "‚Ä¢ üá∑üá∫ ‚Üí üá©üá™ —Ä—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/next - —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ\n"
        "/themes - –≤—ã–±—Ä–∞—Ç—å —Ç–µ–º—É —Å–ª–æ–≤\n"
        "/mode - –≤—ã–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞\n\n"
        "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º üá©üá™ ‚Üí üá∑üá∫ –∏ –≤—Å–µ —Ç–µ–º—ã –≤–ø–µ—Ä–µ–º–µ—à–∫—É.\n\n"
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Å–ª–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º–µ."
    )
    await message.answer(text)

    reset_progress(uid)
    await send_new_word(uid, message.chat.id)


@dp.message(Command("next"))
async def cmd_next(message: Message) -> None:
    uid = message.from_user.id
    state = user_state[uid]

    # –µ—Å–ª–∏ —Å–ª–æ–≤–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å, –Ω–æ–≤—ã–π –∫—Ä—É–≥
    if state["remaining"] is not None and not state["remaining"]:
        reset_progress(uid)

    await send_new_word(uid, message.chat.id)


@dp.message(Command("themes"))
async def cmd_themes(message: Message) -> None:
    kb = build_themes_keyboard()
    await message.answer("–í—ã–±–µ—Ä–∏ —Ç–µ–º—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.", reply_markup=kb)


@dp.message(Command("mode"))
async def cmd_mode(message: Message) -> None:
    kb = build_mode_keyboard()
    await message.answer("–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞.", reply_markup=kb)


@dp.callback_query(F.data.startswith("mode|"))
async def cb_mode(callback: CallbackQuery) -> None:
    uid = callback.from_user.id
    _, mode = callback.data.split("|", maxsplit=1)
    user_state[uid]["mode"] = mode
    if mode == "de_ru":
        txt = "–†–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: üá©üá™ ‚Üí üá∑üá∫."
    else:
        txt = "–†–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: üá∑üá∫ ‚Üí üá©üá™."
    await callback.answer("–†–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω.")
    await callback.message.edit_text(txt)


@dp.callback_query(F.data.startswith("topic|"))
async def cb_topic(callback: CallbackQuery) -> None:
    uid = callback.from_user.id
    _, topic = callback.data.split("|", maxsplit=1)
    user_state[uid]["topic"] = topic

    # –Ω–æ–≤—ã–π –∫—Ä—É–≥ –¥–ª—è –Ω–æ–≤–æ–π —Ç–µ–º—ã
    reset_progress(uid)
    count = len(WORDS_BY_TOPIC.get(topic, []))

    await callback.answer("–¢–µ–º–∞ –≤—ã–±—Ä–∞–Ω–∞.")
    await callback.message.edit_text(f"–¢–µ–º–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {topic}.\n–°–ª–æ–≤ –≤ —Ç–µ–º–µ: {count}.")
    await send_new_word(uid, callback.message.chat.id)


@dp.callback_query(F.data.startswith("ans|"))
async def cb_answer(callback: CallbackQuery) -> None:
    uid = callback.from_user.id
    state = user_state[uid]

    _, word_id_str, mode, is_correct_str = callback.data.split("|")
    word_id = int(word_id_str)
    is_correct = is_correct_str == "1"
    w = WORDS[word_id]

    if is_correct:
        state["correct"] += 1
        if mode == "de_ru":
            text = f'‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ.\n{w["de"]} [{w["tr"]}] - {w["ru"]}'
        else:
            text = f'‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ.\n{w["ru"]} - {w["de"]} [{w["tr"]}]'
    else:
        state["wrong"] += 1
        if mode == "de_ru":
            text = f'‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n{w["de"]} [{w["tr"]}] - {w["ru"]}'
        else:
            text = f'‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n{w["ru"]} - {w["de"]} [{w["tr"]}]'

    finished_now = not state["remaining"]  # –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —É–∂–µ –ø—É—Å—Ç–æ–π, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å

    if finished_now:
        text += (
            "\n\n–¢—ã –ø—Ä–æ—à–µ–ª –≤—Å–µ —Å–ª–æ–≤–∞ –≤ —ç—Ç–æ–π —Ç–µ–º–µ.\n"
            f'‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {state["correct"]}\n'
            f'‚ùå –û—à–∏–±–æ–∫: {state["wrong"]}\n\n'
            "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫—Ä—É–≥ –∑–∞–Ω–æ–≤–æ, –Ω–∞–±–µ—Ä–∏ /next –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥—É—é —Ç–µ–º—É —á–µ—Ä–µ–∑ /themes."
        )

    try:
        await callback.message.edit_text(text)
    except Exception:
        await callback.message.answer(text)

    await callback.answer()

    # –µ—Å–ª–∏ –µ—â–µ –æ—Å—Ç–∞–ª–∏—Å—å —Å–ª–æ–≤–∞ –≤ —Ç–µ–º–µ, –¥–∞–µ–º –Ω–æ–≤–æ–µ
    if not finished_now:
        await send_new_word(uid, callback.message.chat.id)


async def main() -> None:
    load_words("words.json")
    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–ª–æ–≤: {len(WORDS)}")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
