# bot.py
import asyncio
import json
import os
import random
from dataclasses import dataclass, field
from pathlib import Path
from typing import Dict, List, Optional

from aiogram import Bot, Dispatcher, F
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, CallbackQuery
from aiogram.utils.keyboard import InlineKeyboardBuilder

# =============== –ù–ê–°–¢–†–û–ô–ö–ò ===============

TOKEN = os.getenv("BOT_TOKEN", "8583421204:AAHB_2Y8RjDQHDQLcqDLJkYfiP6oBqq3SyE")
WORDS_FILE = Path("words.json")

ALL_TOPIC_KEY = "ALL"  # —Å–ø–µ—Ü –∫–ª—é—á –¥–ª—è —Ä–µ–∂–∏–º–∞ "–≤—Å–µ —Ç–µ–º—ã"


# =============== –ú–û–î–ï–õ–ò –ò –ó–ê–ì–†–£–ó–ö–ê ===============

@dataclass
class Word:
    id: int
    de: str
    tr: str
    ru: str
    topic: str


WORDS: List[Word] = []
WORDS_BY_ID: Dict[int, Word] = {}
TOPIC_IDS: Dict[str, List[int]] = {}
TOPIC_COUNTS: Dict[str, int] = {}
TOTAL_WORDS: int = 0


def detect_topic(item: Dict[str, str]) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –ø–æ —Ä—É—Å—Å–∫–æ–º—É –ø–µ—Ä–µ–≤–æ–¥—É."""
    ru = item.get("ru", "").lower()
    de = item.get("de", "").lower()

    # –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã
    if any(k in ru for k in [
        "–ø—Ä–∏–≤–µ—Ç", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
        "–¥–æ–±—Ä–æ–π –Ω–æ—á–∏", "–∫–∞–∫ –¥–µ–ª–∞", "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è", "—Å–ø–∞—Å–∏–±–æ",
        "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞", "–∏–∑–≤–∏–Ω–∏", "–º–Ω–µ –∂–∞–ª—å", "–¥–∞", "–Ω–µ—Ç"
    ]):
        return "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã"

    # –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if any(k in ru for k in [
        "–∏–º—è", "—Ñ–∞–º–∏–ª–∏—è", "—É–ª–∏—Ü–∞", "–∞–¥—Ä–µ—Å", "–ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å",
        "–º–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è", "–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", "–ø–æ–¥–ø–∏—Å—å",
        "–≤–æ–∑—Ä–∞—Å—Ç", "—Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ", "–ø–æ—á—Ç–∞", "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å"
    ]):
        return "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"

    # —Å–µ–º—å—è
    if any(k in ru for k in [
        "—Å–µ–º—å—è", "–º–∞—Ç—å", "–æ—Ç–µ—Ü", "—Å—ã–Ω", "–¥–æ—á—å", "–±—Ä–∞—Ç—å—è –∏ —Å–µ—Å—Ç—Ä—ã",
        "–±–∞–±—É—à–∫–∞", "–¥–µ–¥", "–≤–Ω—É–∫", "–≤–Ω—É—á–∫–∞", "–º—É–∂—á–∏–Ω–∞ / –º—É–∂",
        "—Ç–µ—Ç—è", "–¥—è–¥—è", "–¥–≤–æ—é—Ä–æ–¥", "–ø–æ–¥—Ä—É–≥–∞", "–¥—Ä—É–≥"
    ]):
        return "–°–µ–º—å—è"

    # –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞
    if any(k in ru for k in [
        "–≤—Ä–∞—á", "—É—á–∏—Ç–µ–ª—å", "–∏–Ω–∂–µ–Ω–µ—Ä", "–ø–æ–≤–∞—Ä", "–º–µ–¥–±—Ä–∞—Ç", "–º–µ–¥—Å–µ—Å—Ç—Ä–∞",
        "—Ç–∞–∫—Å–∏—Å—Ç", "–ø—Ä–æ–¥–∞–≤–µ—Ü", "–ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä", "–æ—Ñ–∏—Ü–∏–∞–Ω—Ç", "–∞–∫—Ç–µ—Ä",
        "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ", "–¥–æ–º–æ—Ö–æ–∑—è", "–ø–æ–ª–∏—Ü–µ–π—Å–∫", "—Å—Ç—É–¥–µ–Ω—Ç", "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫",
        "–ø—Ä–æ—Ñ–µ—Å—Å–∏—è", "—Ä–∞–±–æ—Ç–∞", "–æ—Ñ–∏—Å", "—Ñ–∏—Ä–º–∞", "–∑–∞—Ä–ø–ª–∞—Ç–∞",
        "—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ", "–∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É"
    ]):
        return "–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞"

    # –±–∞–∑–æ–≤—ã–µ –≥–ª–∞–≥–æ–ª—ã
    if any(k in ru for k in [
        "–±—ã—Ç—å", "–∏–º–µ—Ç—å", "–∂–∏—Ç—å", "–≥–æ–≤–æ—Ä–∏—Ç—å", "—É—á–∏—Ç—å—Å—è", "—Ä–∞–±–æ—Ç–∞—Ç—å",
        "–µ—Å—Ç—å", "–≥–æ—Ç–æ–≤–∏—Ç—å", "–∏—Å–∫–∞—Ç—å", "–∏–¥—Ç–∏", "–∑–≤–æ–Ω–∏—Ç—å", "–¥—É–º–∞—Ç—å",
        "–¥–µ–ª–∞—Ç—å", "—Å—á–∏—Ç–∞—Ç—å", "–ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å", "–ª—é–±–∏—Ç—å", "—Ö–æ—Ç–µ–ª –±—ã",
        "–Ω—É–∂–¥–∞—Ç—å—Å—è", "–¥–∞–≤–∞—Ç—å", "–ø–æ–∫—É–ø–∞—Ç—å", "–ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å",
        "—Å–∞–¥–∏—Ç—å—Å—è", "—Å–∏–¥–µ—Ç—å", "—Å—Ç–æ—è—Ç—å", "–ª–µ–∂–∞—Ç—å", "–±–µ–∂–∞—Ç—å",
        "–ø—Ä—ã–≥–∞—Ç—å", "–∑–∞–±—ã–≤–∞—Ç—å", "–≤—Å–ø–æ–º–∏–Ω–∞—Ç—å", "–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å", "–∂–¥–∞—Ç—å",
        "–º—ã—Ç—å", "—É–±–∏—Ä–∞—Ç—å", "—á–∏–Ω–∏—Ç—å", "—Ä–µ–∑–∞—Ç—å", "–æ—Ç–∫—Ä—ã–≤–∞—Ç—å", "–∑–∞–∫—Ä—ã–≤–∞—Ç—å",
        "–Ω–æ—Å–∏—Ç—å", "–±—Ä–æ—Å–∞—Ç—å", "—Å–≤–µ—Ç–∏—Ç—å", "—Å—á–∏—Ç–∞—Ç—å", "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è"
    ]):
        return "–ë–∞–∑–æ–≤—ã–µ –≥–ª–∞–≥–æ–ª—ã"

    # —à–∫–æ–ª–∞ –∏ —É—á–µ–±–∞
    if any(k in ru for k in [
        "–∫–Ω–∏–≥–∞", "—Ç–µ—Ç—Ä–∞–¥—å", "–¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ", "—É—Ä–æ–∫", "–∫–ª–∞—Å—Å",
        "—ç–∫–∑–∞–º–µ–Ω", "—Ç–µ—Å—Ç", "–ø–æ–≤—Ç–æ—Ä—è—Ç—å", "–æ–±—ä—è—Å–Ω—è—Ç—å", "–ø–æ–Ω–∏–º–∞—Ç—å",
        "–∫—É—Ä—Å", "—à–∫–æ–ª–∞", "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", "—à–∫–æ–ª—å–Ω–∏–∫", "—Å—Ç—É–¥–µ–Ω—Ç"
    ]):
        return "–®–∫–æ–ª–∞ –∏ —É—á–µ–±–∞"

    # –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –≤–µ—â–∏
    if any(k in ru for k in [
        "–±—É–º–∞–≥–∞", "–∫–∞—Ä–∞–Ω–¥–∞—à", "—Ä—É—á–∫–∞", "–ª–∏–Ω–µ–π–∫–∞", "–∫–∞–º–µ—Ä–∞",
        "–ø—Ä–∏–Ω—Ç–µ—Ä", "–Ω–æ—É—Ç–±—É–∫", "—Ç–µ–ª–µ—Ñ–æ–Ω", "—Å—É–º–∫–∞", "—Ä—é–∫–∑–∞–∫",
        "–∫–æ—à–µ–ª–µ–∫", "–∫–ª—é—á", "–Ω–æ–∂–Ω–∏—Ü—ã", "–∑–æ–Ω—Ç", "–æ—á–∫–∏", "–∑–∞–∂–∏–≥–∞–ª–∫–∞",
        "–≥–∞–∑–µ—Ç–∞", "—á–∞—à–∫–∞", "—á–µ–º–æ–¥–∞–Ω"
    ]):
        return "–ü—Ä–µ–¥–º–µ—Ç—ã –∏ –≤–µ—â–∏"

    # –≤—Ä–µ–º—è –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    if any(k in ru for k in [
        "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞", "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞",
        "—Å—É–±–±–æ—Ç–∞", "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", "—É—Ç—Ä–æ", "–ø–æ–ª–¥–µ–Ω—å",
        "–ø–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è", "–≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è",
        "–≤–µ—á–µ—Ä", "–Ω–æ—á—å", "–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å", "–≤—Ä–µ–º—è", "–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è",
        "–≥–æ–¥", "–º–µ—Å—è—Ü", "–≥—Ä–∞–¥—É—Å", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "–Ω–µ–¥–µ–ª—è"
    ]):
        return "–í—Ä–µ–º—è –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å"

    # –µ–¥–∞ –∏ –º–∞–≥–∞–∑–∏–Ω
    if any(k in ru for k in [
        "–∫–æ—Ñ–µ", "—á–∞–π", "–º–æ–ª–æ–∫–æ", "–≤–æ–¥–∞", "—Å–æ–∫", "–ø–∏–≤–æ", "—Ö–ª–µ–±",
        "–±—É–ª–æ—á–∫–∞", "–∫—Ä—É–∞—Å—Å–∞–Ω", "—è–π—Ü–æ", "—è–±–ª–æ–∫–æ", "–≥—Ä—É—à–∞", "—Ñ—Ä—É–∫—Ç—ã",
        "–º—é—Å–ª–∏", "–π–æ–≥—É—Ä—Ç", "—Ç–æ—Ä—Ç", "–∫–æ–ª–±–∞—Å–∞", "—Å—ã—Ä", "–ø–æ–∫—É–ø–∫–∞",
        "–µ–≤—Ä–æ", "—Ü–µ–Ω—Ç", "–∫–ª–∏–µ–Ω—Ç", "–ø–∞–∫–µ—Ç", "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç",
        "–ø—Ä–æ–¥—É–∫—Ç –ø–∏—Ç–∞–Ω–∏—è", "–æ–≤–æ—â–∏", "–º—è—Å–æ", "–Ω–∞–ø–∏—Ç–æ–∫", "–¥–µ—Å–µ—Ä—Ç",
        "–µ–¥–∞", "–ª—é–±–∏–º–∞—è –µ–¥–∞", "—Ä–∏—Å", "—à–æ–∫–æ–ª–∞–¥", "–º–æ—Ä–æ–∂–µ–Ω–æ–µ",
        "—É–∂–∏–Ω", "–æ–±–µ–¥", "–∑–∞–≤—Ç—Ä–∞–∫", "–º–∞—Å–ª–æ", "—Ä—ã–±–∞", "—Å—á–µ—Ç –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ",
        "–≤–µ–≥–∞–Ω—Å–∫–∏–π", "–≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–∏–π"
    ]):
        return "–ï–¥–∞ –∏ –º–∞–≥–∞–∑–∏–Ω"

    # –ø–æ–≥–æ–¥–∞ –∏ –ø—Ä–∏—Ä–æ–¥–∞
    if any(k in ru for k in [
        "–ø–æ–≥–æ–¥–∞", "–ø–∞—Å–º—É—Ä–Ω–æ", "–∏–¥–µ—Ç –¥–æ–∂–¥—å", "–∏–¥–µ—Ç —Å–Ω–µ–≥", "—Å–≤–µ—Ç–∏—Ç —Å–æ–ª–Ω—Ü–µ",
        "—Ç–µ–ø–ª–æ", "—Ö–æ–ª–æ–¥–Ω–æ", "–≤–µ—Å–Ω–∞", "–ª–µ—Ç–æ", "–æ—Å–µ–Ω—å", "–∑–∏–º–∞", "–≥—Ä–∞–¥—É—Å",
        "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "–ª–µ—Å", "—Ä–µ–∫–∞", "—Ä—É—á–µ–π", "—Ö–æ–ª–º", "–ª—É–≥",
        "–ø–æ–ª–µ", "—Å–∫–∞–ª–∞", "–ø–ª—è–∂", "—Ä–∞–¥—É–≥–∞", "—à—Ç–æ—Ä–º", "–Ω–µ–±–æ", "–æ–±–ª–∞–∫–æ",
        "–ø—Ä–∏—Ä–æ–¥–∞", "–∑–µ–º–ª—è", "–∫–ª–∏–º–∞—Ç", "—Å–Ω–µ–≥", "—Ç—É–º–∞–Ω", "–≤–µ—Ç–µ—Ä"
    ]):
        return "–ü–æ–≥–æ–¥–∞ –∏ –ø—Ä–∏—Ä–æ–¥–∞"

    # –¥–æ–º –∏ –∂–∏–ª—å–µ
    if any(k in ru for k in [
        "–¥–æ–º", "–∫–≤–∞—Ä—Ç–∏—Ä–∞", "–∫–æ–º–Ω–∞—Ç–∞", "–≥–æ—Å—Ç–∏–Ω–∞—è", "—Å–ø–∞–ª—å–Ω—è",
        "–∫—É—Ö–Ω—è", "–≤–∞–Ω–Ω–∞—è", "—Ç—É–∞–ª–µ—Ç", "–∫–æ—Ä–∏–¥–æ—Ä", "–±–∞–ª–∫–æ–Ω", "—Å–∞–¥",
        "–æ–∫–Ω–æ", "–¥–≤–µ—Ä—å", "—Å—Ç–æ–ª", "—Å—Ç—É–ª", "–∫—Ä–æ–≤–∞—Ç—å", "—à–∫–∞—Ñ",
        "–ª–∞–º–ø–∞", "–∫–æ–≤–µ—Ä", "—Ç–µ–ª–µ–≤–∏–∑–æ—Ä", "—Å—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞",
        "—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫", "–ø–ª–∏—Ç–∞", "–¥—É—Ö–æ–≤–∫–∞", "–¥—É—à", "–≤–∞–Ω–Ω–∞ (–∫–∞–∫ –ø—Ä–µ–¥–º–µ—Ç)",
        "–ø—ã–ª–µ—Å–æ—Å", "–≤–µ–¥—Ä–æ", "–º—É—Å–æ—Ä", "–º—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç", "–º—É—Å–æ—Ä–Ω—ã–π –±–∞–∫"
    ]):
        return "–î–æ–º –∏ –∂–∏–ª—å–µ"

    # –≥–æ—Ä–æ–¥ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
    if any(k in ru for k in [
        "–≥–æ—Ä–æ–¥", "–¥–µ—Ä–µ–≤–Ω—è", "—É–ª–∏—Ü–∞", "–ø–ª–æ—â–∞–¥—å", "–ø–∞—Ä–∫", "–º–æ—Å—Ç",
        "–≤–æ–∫–∑–∞–ª", "–∞—ç—Ä–æ–ø–æ—Ä—Ç", "–æ—Å—Ç–∞–Ω–æ–≤–∫–∞", "–∞–≤—Ç–æ–±—É—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞",
        "–º–µ—Ç—Ä–æ", "–≥–æ—Ä–æ–¥—Å–∫–∞—è —ç–ª–µ–∫—Ç—Ä–∏—á–∫–∞", "–ø–æ–µ–∑–¥", "–∞–≤—Ç–æ–±—É—Å", "—Ç–∞–∫—Å–∏",
        "–∞–ø—Ç–µ–∫–∞", "–ø–µ–∫–∞—Ä–Ω—è", "–±–∞–Ω–∫", "–ø–æ—á—Ç–∞", "–ø–æ–ª–∏—Ü–∏—è", "—à–∫–æ–ª–∞",
        "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", "–¥–µ—Ç—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞", "–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä", "—Ç–µ–∞—Ç—Ä",
        "–º—É–∑–µ–π", "–±–æ–ª—å–Ω–∏—Ü–∞", "–ø–æ—Ä—Ç", "—Ä—ã–Ω–æ–∫", "–ø–∞—Ä–∫–æ–≤–∫–∞", "—Ä–∞–π–æ–Ω"
    ]):
        return "–ì–æ—Ä–æ–¥ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç"

    # —Ç–µ–ª–æ –∏ –∑–¥–æ—Ä–æ–≤—å–µ
    if any(k in ru for k in [
        "–≥–æ–ª–æ–≤–∞", "–ª–∏—Ü–æ", "–ª–æ–±", "–≥–ª–∞–∑", "–±—Ä–æ–≤—å", "–Ω–æ—Å", "—Ä–æ—Ç",
        "–∑—É–±", "—É—Ö–æ", "–≤–æ–ª–æ—Å", "—à–µ—è", "–ø–ª–µ—á–æ", "—Ä—É–∫–∞", "–∫–∏—Å—Ç—å",
        "–ø–∞–ª–µ—Ü", "–≥—Ä—É–¥—å", "—Å–ø–∏–Ω–∞", "–∂–∏–≤–æ—Ç", "–Ω–æ–≥–∞", "—Å—Ç–æ–ø–∞",
        "–∫–æ–ª–µ–Ω–æ", "–∫–æ—Å—Ç—å", "–∫—Ä–æ–≤—å", "–ª–µ–≥–∫–æ–µ", "–ø–µ—á–µ–Ω—å", "–º—ã—à—Ü–∞",
        "–∑–¥–æ—Ä–æ–≤—ã–π", "–±–æ–ª—å–Ω–æ–π", "—É—Å—Ç–∞–≤—à–∏–π", "–∑–¥–æ—Ä–æ–≤—å–µ", "–±–æ–ª—å",
        "–≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å", "–±–æ–ª—å –≤ –≥–æ—Ä–ª–µ", "–ø—Ä–æ—Å—Ç—É–¥–∞", "–≥—Ä–∏–ø–ø",
        "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "—Ç–∞–±–ª–µ—Ç–∫–∞", "–ª–µ–∫–∞—Ä—Å—Ç–≤–æ", "–º–∞–∑—å", "–ø–æ–≤—è–∑–∫–∞",
        "–±–∏–Ω—Ç", "–ø—Ä–∏—ë–º —É –≤—Ä–∞—á–∞", "–ø–∞—Ü–∏–µ–Ω—Ç"
    ]):
        return "–¢–µ–ª–æ –∏ –∑–¥–æ—Ä–æ–≤—å–µ"

    # —ç–º–æ—Ü–∏–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä
    if any(k in ru for k in [
        "—Å—á–∞—Å—Ç–ª–∏–≤—ã–π", "–≥—Ä—É—Å—Ç–Ω—ã–π", "–∑–ª–æ–π", "—Å–ø–æ–∫–æ–π–Ω—ã–π", "–Ω–µ—Ä–≤–Ω—ã–π",
        "—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π", "–≥–æ—Ä–¥—ã–π", "–∑–∞—Å—Ç–µ–Ω—á–∏–≤—ã–π", "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π",
        "–≥–æ—Ç–æ–≤—ã–π –ø–æ–º–æ—á—å", "–≤–µ–∂–ª–∏–≤—ã–π", "–Ω–µ–≤–µ–∂–ª–∏–≤—ã–π", "—Å—Ç—Ä–∞–Ω–Ω—ã–π",
        "—Å–º–µ—à–Ω–æ–π", "—Å–µ—Ä—å–µ–∑–Ω—ã–π", "—Å–∫—É—á–Ω—ã–π", "–∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π",
        "–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π", "–≤–∞–∂–Ω—ã–π", "–ª–µ–≥–∫–∏–π", "—Å–ª–æ–∂–Ω—ã–π", "—á–µ—Å—Ç–Ω—ã–π",
        "–ª–µ–Ω–∏–≤—ã–π", "—Ç—Ä—É–¥–æ–ª—é–±–∏–≤—ã–π", "—Å–º–µ–ª—ã–π", "—Ç—Ä—É—Å–ª–∏–≤—ã–π", "—É–º–Ω—ã–π",
        "–≥–ª—É–ø—ã–π", "—Å–ø–æ–∫–æ–π–Ω—ã–π", "–≥—Ä–æ–º–∫–∏–π", "–Ω–∞–≥–ª—ã–π", "—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π",
        "–Ω–µ—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π", "—Å–∏–º–ø–∞—Ç–∏—á–Ω—ã–π", "–Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π", "—Å —á—É–≤—Å—Ç–≤–æ–º —é–º–æ—Ä–∞",
        "—É—Å–ø–µ—à–Ω—ã–π", "–ª—é–±–æ–ø—ã—Ç–Ω—ã–π"
    ]):
        return "–≠–º–æ—Ü–∏–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä"

    # —Ö–æ–±–±–∏ –∏ —Å–ø–æ—Ä—Ç
    if any(k in ru for k in [
        "—Å–ø–æ—Ä—Ç", "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", "–∫–æ–º–∞–Ω–¥–∞", "–º—É–∑—ã–∫–∞", "—Å–ª—É—à–∞—Ç—å",
        "—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å", "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å", "–ø–∏–∞–Ω–∏–Ω–æ", "—Ä–∏—Å–æ–≤–∞—Ç—å",
        "—à–∏—Ç—å", "–ø–ª–∞–≤–∞—Ç—å", "–ø–µ—Ç—å", "–≥–∏—Ç–∞—Ä–∞", "–≤–∏–¥–µ–æ", "—Ö–æ–±–±–∏",
        "—Ñ–∏–ª—å–º", "—Å–µ—Ä–∏–∞–ª", "–≤–µ–ª–æ—Å–∏–ø–µ–¥", "–∏–≥—Ä–∞", "–≤—ã–∏–≥—Ä—ã–≤–∞—Ç—å"
    ]):
        return "–•–æ–±–±–∏ –∏ —Å–ø–æ—Ä—Ç"

    # –∂–∏–≤–æ—Ç–Ω—ã–µ
    if any(k in ru for k in [
        "–∂–∏–≤–æ—Ç–Ω–æ–µ", "—Å–æ–±–∞–∫–∞", "–∫–æ—à–∫–∞", "–ø—Ç–∏—Ü–∞", "–ª–æ—à–∞–¥—å",
        "–∫–æ—Ä–æ–≤–∞", "—Å–≤–∏–Ω—å—è", "–æ–≤—Ü–∞", "–º—ã—à—å", "–º–µ–¥–≤–µ–¥—å", "–ª–µ–≤",
        "–∑–º–µ—è", "—Ç–∏–≥—Ä", "–∑–∞—è—Ü", "–æ–±–µ–∑—å—è–Ω–∞", "–≤–µ—Ä–±–ª—é–¥", "–≤–æ–ª–∫",
        "–ª–∏—Å–∞", "–ø–µ—Ç—É—Ö", "—É—Ç–∫–∞"
    ]):
        return "–ñ–∏–≤–æ—Ç–Ω—ã–µ"

    # –æ–¥–µ–∂–¥–∞
    if any(k in ru for k in [
        "—Ä—É–±–∞—à–∫–∞", "—à—Ç–∞–Ω—ã", "–¥–∂–∏–Ω—Å—ã", "—Ñ—É—Ç–±–æ–ª–∫–∞", "—Å–≤–∏—Ç–µ—Ä",
        "–∫—É—Ä—Ç–∫–∞", "–ø–∞–ª—å—Ç–æ", "–±–ª—É–∑–∫–∞", "—é–±–∫–∞", "–ø–ª–∞—Ç—å–µ", "–æ–±—É–≤—å",
        "–±–æ—Ç–∏–Ω–æ–∫", "—Ç—É—Ñ–ª—è", "–Ω–æ—Å–∫–∏", "—Å–∞–ø–æ–≥–∏", "—Ä–µ–º–µ–Ω—å", "—à–ª—è–ø–∞",
        "—à–∞–ø–∫–∞", "—à–∞—Ä—Ñ", "–ø–µ—Ä—á–∞—Ç–∫–∏", "—Ç—Ä—É—Å—ã", "–ª–∏—Ñ—á–∏–∫", "–æ–¥–µ–∂–¥–∞",
        "–º–æ–¥–∞", "—Ç–∫–∞–Ω—å", "–ø—É–≥–æ–≤–∏—Ü–∞", "–º–æ–ª–Ω–∏—è", "—Ä–∞–∑–º–µ—Ä"
    ]):
        return "–û–¥–µ–∂–¥–∞"

    # —Ü–≤–µ—Ç–∞ –∏ —á–∏—Å–ª–∞
    if any(k in ru for k in [
        "—Ü–≤–µ—Ç", "–∫—Ä–∞—Å–Ω—ã–π", "—Å–∏–Ω–∏–π", "–∑–µ–ª–µ–Ω—ã–π", "–∂–µ–ª—Ç—ã–π", "—á–µ—Ä–Ω—ã–π",
        "–±–µ–ª—ã–π", "—Å–µ—Ä—ã–π", "–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π", "–æ—Ä–∞–Ω–∂–µ–≤—ã–π", "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π",
        "—Ä–æ–∑–æ–≤—ã–π", "–Ω–æ–ª—å", "–æ–¥–∏–Ω", "–¥–≤–∞", "—Ç—Ä–∏", "—á–µ—Ç—ã—Ä–µ", "–ø—è—Ç—å",
        "—à–µ—Å—Ç—å", "—Å–µ–º—å", "–≤–æ—Å–µ–º—å", "–¥–µ–≤—è—Ç—å", "–¥–µ—Å—è—Ç—å", "–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å",
        "–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å", "–¥–≤–∞–¥—Ü–∞—Ç—å", "—Ç—Ä–∏–¥—Ü–∞—Ç—å", "—Å–æ—Ä–æ–∫", "–ø—è—Ç—å–¥–µ—Å—è—Ç",
        "—à–µ—Å—Ç–¥–µ—Å—è—Ç", "—Å–µ–º—å–¥–µ—Å—è—Ç", "–≤–æ—Å–µ–º—å–¥–µ—Å—è—Ç", "–¥–µ–≤—è–Ω–æ—Å—Ç–æ", "—Å—Ç–æ"
    ]):
        return "–¶–≤–µ—Ç–∞ –∏ —á–∏—Å–ª–∞"

    # –∫–æ–º–ø—å—é—Ç–µ—Ä –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
    if any(k in ru for k in [
        "–∫–æ–º–ø—å—é—Ç–µ—Ä", "–Ω–æ—É—Ç–±—É–∫", "–º—ã—à—å", "–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞", "—ç–∫—Ä–∞–Ω",
        "—Ñ–∞–π–ª", "–ø–∞–ø–∫–∞", "—Å–æ—Ö—Ä–∞–Ω—è—Ç—å", "—É–¥–∞–ª—è—Ç—å", "–ø–∞—Ä–æ–ª—å", "–≤—Ö–æ–¥–∏—Ç—å",
        "–≤—ã—Ö–æ–¥–∏—Ç—å", "–ø—Ä–æ–≥—Ä–∞–º–º–∞", "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "—Å–∫–∞—á–∏–≤–∞—Ç—å",
        "–∑–∞–≥—Ä—É–∂–∞—Ç—å", "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "–≤–∞–π-—Ñ–∞–π", "–ø–µ—á–∞—Ç–∞—Ç—å"
    ]):
        return "–ö–æ–º–ø—å—é—Ç–µ—Ä –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç"

    # –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –±—ã—Ç
    if any(k in ru for k in [
        "–ø—ã–ª–µ—Å–æ—Å", "–º–µ—Ç–ª–∞", "–≤–µ–¥—Ä–æ", "–≥—É–±–∫–∞", "—Ç—Ä—è–ø–∫–∞",
        "—Ä–æ–∑–µ—Ç–∫–∞", "–≤–∏–ª–∫–∞", "–ª–∞–º–ø–æ—á–∫–∞", "–º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞",
        "—á–∞–π–Ω–∏–∫ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π", "–∫–∞—Å—Ç—Ä—é–ª—è", "—Å–∫–æ–≤–æ—Ä–æ–¥–∞",
        "–º—É—Å–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç", "–º—É—Å–æ—Ä–Ω—ã–π –±–∞–∫", "–±–∞–ª–∫–æ–Ω", "–≤—Ö–æ–¥",
        "–º–æ–ª–æ—Ç–æ–∫", "–≥–≤–æ–∑–¥—å", "–≤–∏–Ω—Ç", "–æ—Ç–≤–µ—Ä—Ç–∫–∞", "–¥—Ä–µ–ª—å",
        "–ø–∏–ª–∞", "–ø–ª–æ—Å–∫–æ–≥—É–±—Ü—ã", "—à–ª–∞–Ω–≥", "–∫–ª–µ–π", "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç"
    ]):
        return "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –±—ã—Ç"

    # –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è
    if any(k in ru for k in [
        "–∏–¥–µ—è", "–º–µ—á—Ç–∞", "—Å–æ–Ω", "–∂–µ–ª–∞–Ω–∏–µ", "–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å", "–ø—Ä–æ–±–ª–µ–º–∞",
        "—Ä–µ—à–µ–Ω–∏–µ", "–≤–æ–ø—Ä–æ—Å", "–æ—Ç–≤–µ—Ç", "–±—É–¥—É—â–µ–µ", "–ø—Ä–æ—à–ª–æ–µ",
        "–Ω–∞—Å—Ç–æ—è—â–µ–µ", "—Å—Ç—Ä–∞–Ω–∏—Ü–∞", "—Å—Ç–æ—Ä–æ–Ω–∞", "–Ω–∞—á–∞–ª–æ", "–∫–æ–Ω–µ—Ü",
        "—Å–µ—Ä–µ–¥–∏–Ω–∞", "–ø—Ä–∏—á–∏–Ω–∞", "–æ—à–∏–±–∫–∞", "–æ–ø—ã—Ç", "–ø–æ–º–æ—â—å", "—Ü–µ–ª—å",
        "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–Ω–∞–¥–µ–∂–¥–∞", "—É–≤–∞–∂–µ–Ω–∏–µ", "—Å–æ–º–Ω–µ–Ω–∏–µ", "—Ç–µ—Ä–ø–µ–Ω–∏–µ"
    ]):
        return "–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è"

    # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    return "–°–ª–æ–≤–∞—Ä—å A1-B1"


def load_words() -> None:
    """–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞ –∏–∑ words.json –∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º —Ç–µ–º—ã."""
    global WORDS, WORDS_BY_ID, TOPIC_IDS, TOPIC_COUNTS, TOTAL_WORDS

    with WORDS_FILE.open("r", encoding="utf-8") as f:
        data = json.load(f)

    WORDS = []
    WORDS_BY_ID = {}
    TOPIC_IDS = {}
    TOPIC_COUNTS = {}

    for idx, item in enumerate(data):
        topic = item.get("topic")
        if not topic:
            topic = detect_topic(item)

        w = Word(
            id=idx,
            de=item["de"],
            tr=item.get("tr", ""),
            ru=item["ru"],
            topic=topic,
        )

        WORDS.append(w)
        WORDS_BY_ID[w.id] = w
        TOPIC_IDS.setdefault(topic, []).append(w.id)
        TOPIC_COUNTS[topic] = TOPIC_COUNTS.get(topic, 0) + 1

    TOTAL_WORDS = len(WORDS)
    print(f"Loaded {TOTAL_WORDS} words, topics: {len(TOPIC_IDS)}")


# =============== –°–û–°–¢–û–Ø–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===============

@dataclass
class UserState:
    mode: str = "de_ru"        # de_ru, ru_de, mixed
    topic: str = ALL_TOPIC_KEY # ALL –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ–º–∞
    remaining_ids: List[int] = field(default_factory=list)
    current_word_id: Optional[int] = None
    correct: int = 0
    wrong: int = 0

    def reset_stats(self) -> None:
        self.correct = 0
        self.wrong = 0

    def reset_pool(self) -> None:
        if self.topic == ALL_TOPIC_KEY:
            ids = [w.id for w in WORDS]
        else:
            ids = TOPIC_IDS.get(self.topic, [])
        random.shuffle(ids)
        self.remaining_ids = ids
        self.current_word_id = None


USER_STATES: Dict[int, UserState] = {}


def get_user_state(user_id: int) -> UserState:
    state = USER_STATES.get(user_id)
    if state is None:
        state = UserState()
        state.reset_pool()
        USER_STATES[user_id] = state
    return state


# =============== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===============

def get_topics_ordered() -> List[str]:
    return sorted(TOPIC_IDS.keys())


def format_word_question_de_ru(w: Word) -> str:
    return f"{w.de} [{w.tr}]" if w.tr else w.de


def format_word_full_de(w: Word) -> str:
    if w.tr:
        return f"{w.de} [{w.tr}]"
    return w.de


def pick_wrong_answers(correct_word: Word, direction: str, count: int = 3) -> List[str]:
    """–ü–æ–¥–±–∏—Ä–∞–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ —á—Ç–æ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π."""
    if direction == "de_ru":
        correct = correct_word.ru
        pool = [w.ru for w in WORDS if w.id != correct_word.id]
    else:
        correct = format_word_full_de(correct_word)
        pool = [format_word_full_de(w) for w in WORDS if w.id != correct_word.id]

    pool = list(set(pool))
    if correct in pool:
        pool.remove(correct)

    if len(pool) <= count:
        return random.sample(pool, k=min(len(pool), count))

    return random.sample(pool, k=count)


async def send_stats(message: Message, state: UserState) -> None:
    total = state.correct + state.wrong
    if total == 0:
        await message.answer("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—å —Ö–æ—Ç—è –±—ã –Ω–∞ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å.")
        return

    topic_name = "–í—Å–µ —Ç–µ–º—ã" if state.topic == ALL_TOPIC_KEY else state.topic

    text = (
        f"–¢–µ–º–∞: <b>{topic_name}</b>\n"
        f"–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: <b>{total}</b>\n"
        f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <b>{state.correct}</b>\n"
        f"–û—à–∏–±–æ–∫: <b>{state.wrong}</b>"
    )
    await message.answer(text)


async def send_next_question(target, user_id: int) -> None:
    """target - —ç—Ç–æ Message –∏–ª–∏ CallbackQuery.message."""
    state = get_user_state(user_id)

    # –µ—Å–ª–∏ —Å–ª–æ–≤–∞ –≤ —Ç–µ–º–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
    if not state.remaining_ids:
        await send_stats(target, state)
        state.reset_stats()
        state.reset_pool()
        await target.answer(
            "–¢—ã –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤—Å–µ —Å–ª–æ–≤–∞ –≤ —ç—Ç–æ–π —Ç–µ–º–µ. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã—à–µ.\n"
            "–Ø –∑–∞–Ω–æ–≤–æ –ø–µ—Ä–µ–º–µ—à–∞–ª —Å–ª–æ–≤–∞. –ú–æ–∂–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å —Ç–æ–π –∂–µ —Ç–µ–º–æ–π –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —á–µ—Ä–µ–∑ /themes."
        )
        return

    # –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ
    word_id = state.remaining_ids.pop()
    state.current_word_id = word_id
    word = WORDS_BY_ID[word_id]

    # –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    if state.mode == "mixed":
        direction = random.choice(["de_ru", "ru_de"])
    else:
        direction = state.mode

    if direction == "de_ru":
        question_text = format_word_question_de_ru(word)
        correct_option = word.ru
    else:
        question_text = word.ru
        correct_option = format_word_full_de(word)

    wrong_options = pick_wrong_answers(word, direction, count=3)
    options = [correct_option] + wrong_options
    random.shuffle(options)

    kb = InlineKeyboardBuilder()
    for option in options:
        is_correct = 1 if option == correct_option else 0
        cb_data = f"ans:{word_id}:{is_correct}"
        kb.button(text=option, callback_data=cb_data)
    kb.adjust(2)

    text = f"–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥:\n\n<b>{question_text}</b>"
    await target.answer(text, reply_markup=kb.as_markup())


# =============== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–û–¢–ê ===============

bot = Bot(TOKEN, parse_mode="HTML")
dp = Dispatcher()


# =============== –ö–û–ú–ê–ù–î–´ ===============

@dp.message(CommandStart())
async def cmd_start(message: Message) -> None:
    state = get_user_state(message.from_user.id)
    state.reset_stats()
    state.reset_pool()

    topics_count = len(TOPIC_IDS)

    text = (
        "üá©üá™ –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –Ω–µ–º–µ—Ü–∫–∏—Ö —Å–ª–æ–≤.\n\n"
        "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:\n"
        "‚Ä¢ –Ø –ø–æ–∫–∞–∑—ã–≤–∞—é —Å–ª–æ–≤–æ –∏ 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∞.\n"
        "‚Ä¢ –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–º.\n"
        "‚Ä¢ –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π, —è –ø–æ–∫–∞–∂—É –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ —Å—Ä–∞–∑—É –¥–∞–º –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ.\n"
        "‚Ä¢ –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –≤–µ—Ä–Ω—ã–π, —è –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂—É —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ.\n\n"
        f"–°–µ–π—á–∞—Å –≤ –±–∞–∑–µ <b>{TOTAL_WORDS}</b> —Å–ª–æ–≤.\n"
        f"–¢–µ–º: <b>{topics_count}</b>.\n\n"
        "–†–µ–∂–∏–º—ã:\n"
        "‚Ä¢ üá©üá™ ‚Üí üá∑üá∫ –Ω–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º.\n"
        "‚Ä¢ üá∑üá∫ ‚Üí üá©üá™ —Ä—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º.\n"
        "‚Ä¢ üé≤ —Å–º–µ—à–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/next - —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ\n"
        "/themes - –≤—ã–±—Ä–∞—Ç—å —Ç–µ–º—É —Å–ª–æ–≤\n"
        "/mode - –≤—ã–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞\n"
        "/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ\n\n"
        "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º üá©üá™ ‚Üí üá∑üá∫ –∏ –≤—Å–µ —Ç–µ–º—ã –≤–ø–µ—Ä–µ–º–µ—à–∫—É.\n"
        "–ù–∞–ø–∏—à–∏ /next, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫–≤–∏–∑."
    )
    await message.answer(text)


@dp.message(Command("next"))
async def cmd_next(message: Message) -> None:
    await send_next_question(message, message.from_user.id)


@dp.message(Command("stats"))
async def cmd_stats(message: Message) -> None:
    state = get_user_state(message.from_user.id)
    await send_stats(message, state)


@dp.message(Command("mode"))
async def cmd_mode(message: Message) -> None:
    kb = InlineKeyboardBuilder()
    kb.button(text="üá©üá™ ‚Üí üá∑üá∫", callback_data="mode:de_ru")
    kb.button(text="üá∑üá∫ ‚Üí üá©üá™", callback_data="mode:ru_de")
    kb.button(text="üé≤ –°–º–µ—à–∞–Ω–Ω—ã–π", callback_data="mode:mixed")
    kb.adjust(1)

    await message.answer("–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞:", reply_markup=kb.as_markup())


@dp.message(Command("themes"))
async def cmd_themes(message: Message) -> None:
    kb = InlineKeyboardBuilder()

    kb.button(text="üé≤ –í—Å–µ —Ç–µ–º—ã (–ø–µ—Ä–µ–º–µ—à–∫—É)", callback_data=f"topic:{ALL_TOPIC_KEY}")

    for topic in get_topics_ordered():
        count = TOPIC_COUNTS.get(topic, 0)
        kb.button(text=f"{topic} ({count})", callback_data=f"topic:{topic}")

    kb.adjust(1)
    await message.answer("–í—ã–±–µ—Ä–∏ —Ç–µ–º—É —Å–ª–æ–≤:", reply_markup=kb.as_markup())


# =============== CALLBACK –ö–ù–û–ü–ö–ò ===============

@dp.callback_query(F.data.startswith("mode:"))
async def callback_mode(call: CallbackQuery) -> None:
    await call.answer()
    mode = call.data.split(":", 1)[1]
    state = get_user_state(call.from_user.id)

    if mode not in {"de_ru", "ru_de", "mixed"}:
        await call.message.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º.")
        return

    state.mode = mode
    names = {
        "de_ru": "üá©üá™ ‚Üí üá∑üá∫ –ù–µ–º–µ—Ü–∫–∏–π –Ω–∞ —Ä—É—Å—Å–∫–∏–π",
        "ru_de": "üá∑üá∫ ‚Üí üá©üá™ –†—É—Å—Å–∫–∏–π –Ω–∞ –Ω–µ–º–µ—Ü–∫–∏–π",
        "mixed": "üé≤ –°–º–µ—à–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º",
    }
    await call.message.answer(
        f"–†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: <b>{names[mode]}</b>.\n–ù–∞–ø–∏—à–∏ /next, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å."
    )


@dp.callback_query(F.data.startswith("topic:"))
async def callback_topic(call: CallbackQuery) -> None:
    await call.answer()
    topic_key = call.data.split(":", 1)[1]
    state = get_user_state(call.from_user.id)

    if topic_key != ALL_TOPIC_KEY and topic_key not in TOPIC_IDS:
        await call.message.answer("–≠—Ç–∞ —Ç–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    state.topic = topic_key
    state.reset_stats()
    state.reset_pool()

    if topic_key == ALL_TOPIC_KEY:
        title = "–í—Å–µ —Ç–µ–º—ã (–ø–µ—Ä–µ–º–µ—à–∫—É)"
        count = TOTAL_WORDS
    else:
        title = topic_key
        count = TOPIC_COUNTS.get(topic_key, 0)

    await call.message.answer(
        f"–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ <b>{title}</b>.\n"
        f"–°–ª–æ–≤ –≤ —ç—Ç–æ–π —Ç–µ–º–µ: <b>{count}</b>.\n"
        "–ù–∞–ø–∏—à–∏ /next, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å."
    )


@dp.callback_query(F.data.startswith("ans:"))
async def callback_answer(call: CallbackQuery) -> None:
    try:
        _, word_id_str, is_correct_str = call.data.split(":")
        word_id = int(word_id_str)
        is_correct = is_correct_str == "1"
    except Exception:
        await call.answer("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö.", show_alert=True)
        return

    state = get_user_state(call.from_user.id)

    if state.current_word_id != word_id:
        await call.answer("–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —É–∂–µ –Ω–µ–∞–∫—Ç—É–∞–ª–µ–Ω. –ù–∞–∂–º–∏ /next.", show_alert=True)
        return

    word = WORDS_BY_ID.get(word_id)
    if not word:
        await call.answer("–°–ª–æ–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", show_alert=True)
        return

    if is_correct:
        state.correct += 1
        await call.answer("–í–µ—Ä–Ω–æ!")
        await send_next_question(call.message, call.from_user.id)
    else:
        state.wrong += 1
        await call.answer("–ù–µ–≤–µ—Ä–Ω–æ.")

        text = (
            "‚ùå –ù–µ–≤–µ—Ä–Ω–æ.\n"
            "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n"
            f"üá©üá™ <b>{format_word_full_de(word)}</b>\n"
            f"üá∑üá∫ <b>{word.ru}</b>"
        )
        await call.message.answer(text)
        await send_next_question(call.message, call.from_user.id)


# =============== –¢–û–ß–ö–ê –í–•–û–î–ê ===============

async def main() -> None:
    load_words()
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())

