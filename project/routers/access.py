from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton

from config import ADMIN_ID
from keyboards.main import build_main_menu_keyboard
from services.access import allowed_users, save_allowed_users, has_access

router = Router()

@router.message(Command("access"))
async def cmd_access(message: Message) -> None:
    uid = message.from_user.id

    if has_access(uid, ADMIN_ID):
        await message.answer("–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É. –ü–æ–ª—å–∑—É–π—Å—è –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é –Ω–∏–∂–µ.")
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø", callback_data=f"allow|{uid}")]
        ]
    )

    txt = (
        "üÜï –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø.\n"
        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.full_name}\n"
        f"ID: {uid}"
    )

    try:
        await message.bot.send_message(ADMIN_ID, txt, reply_markup=kb)
        await message.answer("–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.\n–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è —Ç—ã –ø–æ–ª—É—á–∏—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ.")
    except Exception:
        await message.answer("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")

@router.callback_query(F.data == "req_access")
async def cb_req_access(callback: CallbackQuery) -> None:
    uid = callback.from_user.id

    if has_access(uid, ADMIN_ID):
        await callback.answer("–î–æ—Å—Ç—É–ø —É–∂–µ –µ—Å—Ç—å.")
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø", callback_data=f"allow|{uid}")]
        ]
    )

    txt = (
        "üÜï –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø.\n"
        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {callback.from_user.full_name}\n"
        f"ID: {uid}"
    )

    try:
        await callback.bot.send_message(ADMIN_ID, txt, reply_markup=kb)
        await callback.answer("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        await callback.message.answer("–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–π —Ä–µ—à–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
    except Exception:
        await callback.answer("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.", show_alert=True)

@router.callback_query(F.data.startswith("allow|"))
async def cb_allow_user(callback: CallbackQuery) -> None:
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("–ù–µ—Ç –ø—Ä–∞–≤.", show_alert=True)
        return

    _, user_id_str = callback.data.split("|", maxsplit=1)
    user_id = int(user_id_str)

    allowed_users.add(user_id)
    save_allowed_users()

    await callback.answer("–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω.")
    await callback.message.edit_text(f"‚úÖ –î–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} —Ä–∞–∑—Ä–µ—à–µ–Ω.")

    try:
        text = (
            "‚úÖ –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –æ–¥–æ–±—Ä–µ–Ω.\n\n"
            "–¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.\n\n"
            "–í—ã–±–∏—Ä–∞–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å–ª–æ–≤, –≥—Ä–∞–º–º–∞—Ç–∏–∫—É, –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–æ–∫."
        )
        await callback.bot.send_message(user_id, text, reply_markup=build_main_menu_keyboard())
    except Exception:
        pass
